var ROS3D=ROS3D||{REVISION:"1"};ROS3D.URDF_SPHERE=0;ROS3D.URDF_BOX=1;ROS3D.URDF_CYLINDER=2;ROS3D.URDF_MESH=3;ROS3D.MARKER_ARROW=0;ROS3D.MARKER_CUBE=1;ROS3D.MARKER_SPHERE=2;ROS3D.MARKER_CYLINDER=3;ROS3D.MARKER_LINE_STRIP=4;ROS3D.MARKER_LINE_LIST=5;ROS3D.MARKER_CUBE_LIST=6;ROS3D.MARKER_SPHERE_LIST=7;ROS3D.MARKER_POINTS=8;ROS3D.MARKER_TEXT_VIEW_FACING=9;ROS3D.MARKER_MESH_RESOURCE=10;ROS3D.MARKER_TRIANGLE_LIST=11;ROS3D.INTERACTIVE_MARKER_KEEP_ALIVE=0;ROS3D.INTERACTIVE_MARKER_POSE_UPDATE=1;ROS3D.INTERACTIVE_MARKER_MENU_SELECT=2;ROS3D.INTERACTIVE_MARKER_BUTTON_CLICK=3;ROS3D.INTERACTIVE_MARKER_MOUSE_DOWN=4;ROS3D.INTERACTIVE_MARKER_MOUSE_UP=5;ROS3D.InteractiveMarkerClient=function(a){var b=this;var a=a||{};this.ros=a.ros;this.tfClient=a.tfClient;this.topic=a.topic;this.viewer=a.viewer;this.path="";this.rootObject=a.rootObject||new THREE.Object3D();this.interactiveMarkers={};this.updateTopic=null;this.feedbackTopic=null;if(this.topic){this.subscribe(this.topic)}this.viewer.addSelectableObject(this.rootObject)};ROS3D.InteractiveMarkerClient.prototype.subscribe=function(a){this.unsubscribe();this.updateTopic=new ROSLIB.Topic({ros:this.ros,name:a+"/tunneled/update",messageType:"visualization_msgs/InteractiveMarkerUpdate",compression:"png"});this.updateTopic.subscribe(this.processUpdate.bind(this));this.feedbackTopic=new ROSLIB.Topic({ros:this.ros,name:a+"/feedback",messageType:"visualization_msgs/InteractiveMarkerFeedback",compression:"png"});this.feedbackTopic.advertise();this.initService=new ROSLIB.Service({ros:this.ros,name:a+"/tunneled/get_init",serviceType:"demo_interactive_markers/GetInit"});var b=new ROSLIB.ServiceRequest({});this.initService.callService(b,this.processInit.bind(this))};ROS3D.InteractiveMarkerClient.prototype.unsubscribe=function(){if(this.updateTopic){this.updateTopic.unsubscribe()}if(this.feedbackTopic){this.feedbackTopic.unadvertise()}for(intMarkerName in this.interactiveMarkers){this.eraseIntMarker(intMarkerName)}this.interactiveMarkers={}};ROS3D.InteractiveMarkerClient.prototype.processInit=function(b){var a=b.msg;a.erases=[];for(intMarkerName in this.interactiveMarkers){a.erases.push(intMarkerName)}a.poses=[];this.processUpdate(a)};ROS3D.InteractiveMarkerClient.prototype.processUpdate=function(b){var a=this;b.erases.forEach(function(d){var c=a.interactiveMarkers[d];a.eraseIntMarker(d)});b.poses.forEach(function(d){var c=a.interactiveMarkers[d.name];if(c){c.setPoseFromServer(d.pose)}});b.markers.forEach(function(f){var e=a.interactiveMarkers[f.name];if(e){a.eraseIntMarker(e.name)}var d=new ROS3D.InteractiveMarkerHandle(f,a.feedbackTopic,a.tfClient);a.interactiveMarkers[f.name]=d;var c=new ROS3D.InteractiveMarker(d,a.viewer.camera,a.path);a.rootObject.add(c);d.on("pose",function(g){c.onServerSetPose({pose:g})});c.addEventListener("user_changed_pose",d.setPoseFromClient.bind(d));c.addEventListener("user_mouse_down",d.onMouseDown.bind(d));c.addEventListener("user_mouse_up",d.onMouseUp.bind(d));c.addEventListener("user_button_click",d.onButtonClick.bind(d));c.addEventListener("menu_select",d.onMenuSelect.bind(d));d.subscribeTf(f)})};ROS3D.InteractiveMarkerClient.prototype.eraseIntMarker=function(a){if(this.interactiveMarkers[a]){delete this.interactiveMarkers[a]}};ROS3D.InteractiveMarkerHandle=function(a,c,b){this.feedbackTopic=c;this.tfClient=b;this.name=a.name;this.header=a.header;this.controls=a.controls;this.menuEntries=a.menu_entries;this.dragging=false;this.timeoutHandle=null;this.tfTransform=new ROSLIB.Transform();this.pose=new ROSLIB.Pose();this.setPoseFromServer(a.pose)};ROS3D.InteractiveMarkerHandle.prototype.__proto__=EventEmitter2.prototype;ROS3D.InteractiveMarkerHandle.prototype.subscribeTf=function(a){if(a.header.stamp.secs===0&&a.header.stamp.nsecs===0){this.tfClient.subscribe(a.header.frame_id,this.tfUpdate.bind(this))}};ROS3D.InteractiveMarkerHandle.prototype.emitServerPoseUpdate=function(){var a=new ROSLIB.Pose({position:this.pose.position,orientation:this.pose.orientation});a.applyTransform(this.tfTransform);this.emit("pose",a)};ROS3D.InteractiveMarkerHandle.prototype.setPoseFromServer=function(a){this.pose=new ROSLIB.Pose(a);this.emitServerPoseUpdate()};ROS3D.InteractiveMarkerHandle.prototype.tfUpdate=function(a){this.tfTransform=new ROSLIB.Transform(a);this.emitServerPoseUpdate()};ROS3D.InteractiveMarkerHandle.prototype.setPoseFromClient=function(b){this.pose=new ROSLIB.Pose(b);var a=this.tfTransform.clone();a.rotation.invert();this.pose.applyTransform(a);this.sendFeedback(ROS3D.INTERACTIVE_MARKER_POSE_UPDATE,undefined,0,b.controlName);if(this.dragging){if(this.timeoutHandle){clearTimeout(this.timeoutHandle)}this.timeoutHandle=setTimeout(this.setPoseFromClient.bind(this,b),250)}};ROS3D.InteractiveMarkerHandle.prototype.onButtonClick=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_BUTTON_CLICK,a.clickPosition,0,a.controlName)};ROS3D.InteractiveMarkerHandle.prototype.onMouseDown=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MOUSE_DOWN,a.clickPosition,0,a.controlName);this.dragging=true};ROS3D.InteractiveMarkerHandle.prototype.onMouseUp=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MOUSE_UP,a.clickPosition,0,a.controlName);this.dragging=false;if(this.timeoutHandle){clearTimeout(this.timeoutHandle)}};ROS3D.InteractiveMarkerHandle.prototype.onMenuSelect=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MENU_SELECT,undefined,a.id,a.controlName)};ROS3D.InteractiveMarkerHandle.prototype.sendFeedback=function(b,d,c,f){var e=d!==undefined;var d=d||{x:0,y:0,z:0};var a={header:this.header,client_id:this.client_id,marker_name:this.name,control_name:f,event_type:b,pose:this.pose,mouse_point:d,mouse_point_valid:e,menu_entry_id:c};this.feedbackTopic.publish(a)};ROS3D.MarkerClient=function(b){var c=this;var b=b||{};this.ros=b.ros;this.tfClient=b.tfClient;this.topic=b.topic;this.rootObject=b.rootObject||new THREE.Object3D();this.previousMarker=null;var a=new ROSLIB.Topic({ros:this.ros,name:this.topic,messageType:"visualization_msgs/Marker",compression:"png"});a.subscribe(function(e){var d=new ROS3D.Marker({message:e});if(c.previousMarker){c.rootObject.remove(c.previousMarker)}var f=new ROS3D.SceneNode({frameID:e.header.frame_id,tfClient:c.tfClient,model:d});c.previousMarker=f;c.rootObject.add(f);c.emit("update")})};ROS3D.MarkerClient.prototype.__proto__=EventEmitter2.prototype;ROS3D.UrdfBox=function(b){var c=this;var b=b||{};var a=b.xml;this.dimension=null;this.type=null;var d=function(f){this.type=ROS3D.URDF_BOX;var e=f.getAttribute("size").split(" ");c.dimension=new ROSLIB.Vector3({x:parseFloat(e[0]),y:parseFloat(e[1]),z:parseFloat(e[2])})};d(a)};ROS3D.UrdfColor=function(b){var c=this;var b=b||{};var a=b.xml;this.r=null;this.g=null;this.b=null;this.a=null;var d=function(e){var f=e.getAttribute("rgba").split(" ");c.r=parseFloat(f[0]);c.g=parseFloat(f[1]);c.b=parseFloat(f[2]);c.a=parseFloat(f[3]);return true};d(a)};ROS3D.UrdfCylinder=function(b){var c=this;var b=b||{};var a=b.xml;this.type=null;this.length=null;this.radius=null;var d=function(e){c.type=ROS3D.URDF_CYLINDER;c.length=parseFloat(e.getAttribute("length"));c.radius=parseFloat(e.getAttribute("radius"))};d(a)};ROS3D.UrdfLink=function(b){var c=this;var b=b||{};var a=b.xml;this.name=null;this.visual=null;var d=function(e){c.name=e.getAttribute("name");var f=e.getElementsByTagName("visual");if(f.length>0){c.visual=new ROS3D.UrdfVisual({xml:f[0]})}};d(a)};ROS3D.UrdfMaterial=function(b){var c=this;var b=b||{};var a=b.xml;this.name=null;this.textureFilename=null;this.color=null;var d=function(g){c.name=g.getAttribute("name");var e=g.getElementsByTagName("texture");if(e.length>0){c.textureFilename=e[0].getAttribute("filename")}var f=g.getElementsByTagName("color");if(f.length>0){c.color=new ROS3D.UrdfColor({xml:f[0]})}};d(a)};ROS3D.UrdfMesh=function(b){var c=this;var b=b||{};var a=b.xml;this.filename=null;this.scale=null;this.type=null;var d=function(f){c.type=ROS3D.URDF_MESH;c.filename=f.getAttribute("filename");var g=f.getAttribute("scale");if(g){var e=g.split(" ");c.scale=new ROSLIB.Vector3({x:parseFloat(e[0]),y:parseFloat(e[1]),z:parseFloat(e[2])})}};d(a)};ROS3D.UrdfModel=function(c){var d=this;var c=c||{};var b=c.xml;var a=c.string;this.name;this.materials=[];this.links=[];var e=function(g){var m=g.evaluate("//robot",g,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;d.name=m.getAttribute("name");for(n in m.childNodes){var l=m.childNodes[n];if(l.tagName==="material"){var h=new ROS3D.UrdfMaterial({xml:l});if(d.materials[h.name]){console.warn("Material "+h.name+"is not unique.")}else{d.materials[h.name]=h}}else{if(l.tagName==="link"){var k=new ROS3D.UrdfLink({xml:l});if(d.links[k.name]){console.warn("Link "+k.name+" is not unique.")}else{if(k.visual&&k.visual.material){if(d.materials[k.visual.material.name]){k.visual.material=d.materials[k.visual.material.name]}else{if(k.visual.material){d.materials[k.visual.material.name]=k.visual.material}}}d.links[k.name]=k}}}}};if(a){var f=new DOMParser();b=f.parseFromString(a,"text/xml")}e(b)};ROS3D.UrdfSphere=function(b){var c=this;var b=b||{};var a=b.xml;this.radius=null;this.type=null;var d=function(e){c.type=ROS3D.URDF_SPHERE;c.radius=parseFloat(e.getAttribute("radius"))};d(a)};ROS3D.UrdfVisual=function(b){var c=this;var b=b||{};var a=b.xml;this.origin=null;this.geometry=null;this.material=null;var d=function(m){var e=m.getElementsByTagName("origin");if(e.length===0){c.origin=new ROSLIB.Pose()}else{var E=m.getAttribute("xyz");if(!E){var F=new ROSLIB.Vector3()}else{var E=E.split(" ");var F=new ROSLIB.Vector3({x:parseFloat(E[0]),y:parseFloat(E[1]),z:parseFloat(E[2])})}v=m.getAttribute("rpy");if(!v){var k=new ROSLIB.Quaternion()}else{var v=v.split(" ");var C=parseFloat(v[0]);var p=parseFloat(v[1]);var s=parseFloat(v[2]);var g=C/2;var r=p/2;var D=s/2;var t=Math.sin(g)*Math.cos(r)*Math.cos(D)-Math.cos(g)*Math.sin(r)*Math.sin(D);var q=Math.cos(g)*Math.sin(r)*Math.cos(D)+Math.sin(g)*Math.cos(r)*Math.sin(D);var o=Math.cos(g)*Math.cos(r)*Math.sin(D)-Math.sin(g)*Math.sin(r)*Math.cos(D);var u=Math.cos(g)*Math.cos(r)*Math.cos(D)+Math.sin(g)*Math.sin(r)*Math.sin(D);var k=new ROSLIB.Quaternion({x:t,y:q,z:o,w:u});k.normalize()}c.origin=new ROSLIB.Pose({position:F,orientation:k})}var A=m.getElementsByTagName("geometry");if(A.length>0){var f=null;for(n in A[0].childNodes){var B=A[0].childNodes[n];if(B.nodeType===1){f=B;break}}var l=f.nodeName;if(l==="sphere"){c.geometry=new ROS3D.UrdfSphere({xml:f})}else{if(l==="box"){c.geometry=new ROS3D.UrdfBox({xml:f})}else{if(l==="cylinder"){c.geometry=new ROS3D.UrdfCylinder({xml:f})}else{if(l==="mesh"){c.geometry=new ROS3D.UrdfMesh({xml:f})}else{console.warn("Unknown geometry type "+l)}}}}}var h=m.getElementsByTagName("material");if(h.length>0){c.material=new ROS3D.UrdfMaterial({xml:h[0]})}};d(a)};ROS3D.SceneNode=function(a){var a=a||{};var b=this;this.tfClient=a.tfClient;this.frameID=a.frameID;this.model=a.model;THREE.Object3D.call(this);this.useQuaternion=true;this.add(this.model);this.tfClient.subscribe(this.frameID,function(e){var d=new ROSLIB.Transform(e);var c=new ROSLIB.Pose();c.applyTransform(d);b.position.x=c.position.x;b.position.y=c.position.y;b.position.z=c.position.z;b.quaternion=new THREE.Quaternion(c.orientation.x,c.orientation.y,c.orientation.z,c.orientation.w);b.updateMatrixWorld(true)})};ROS3D.SceneNode.prototype.__proto__=THREE.Object3D.prototype;ROS3D.Viewer=function(d){var e=this;d=d||{};this.divID=d.divID;this.width=d.width;this.height=d.height;this.disableGrid=d.disableGrid;this.gridColor=d.gridColor||"#cccccc";this.background=d.background||"#111111";this.antialias=d.antialias;this.renderer=new THREE.WebGLRenderer({antialias:this.antialias});this.renderer.setClearColorHex(this.background.replace("#","0x"),1);this.renderer.sortObjects=false;this.renderer.setSize(this.width,this.height);this.renderer.shadowMapEnabled=false;this.renderer.autoClear=false;this.scene=new THREE.Scene();this.camera=new THREE.PerspectiveCamera(40,this.width/this.height,0.01,1000);this.camera.position.x=3;this.camera.position.y=3;this.camera.position.z=3;this.cameraControls=new ROS3D.OrbitControls(this.scene,this.camera);this.cameraControls.userZoomSpeed=0.5;if(!this.disableGrid){var b=new THREE.PlaneGeometry(50,50,50,50);var c=new THREE.MeshBasicMaterial({color:this.gridColor,wireframe:true,wireframeLinewidth:1,transparent:true});var g=new THREE.Mesh(b,c);this.scene.add(g)}this.scene.add(new THREE.AmbientLight(5592405));this.directionalLight=new THREE.DirectionalLight(16777215);this.scene.add(this.directionalLight);this.selectableObjs=new THREE.Object3D;this.scene.add(this.selectableObjs);var f=new ROS3D.MouseHandler(this.renderer,this.camera,this.selectableObjs,this.cameraControls);this.highlighter=new ROS3D.Highlighter(f);function a(){e.cameraControls.update();e.directionalLight.position=e.camera.localToWorld(new THREE.Vector3(-1,1,0));e.directionalLight.position.normalize();e.renderer.clear(true,true,true);e.renderer.render(e.scene,e.camera);e.highlighter.renderHighlight(e.renderer,e.scene,e.camera);requestAnimationFrame(a)}document.getElementById(this.divID).appendChild(this.renderer.domElement);a()};ROS3D.Viewer.prototype.addObject=function(a){this.scene.add(a)};ROS3D.Viewer.prototype.addSelectableObject=function(a){this.selectableObjs.add(a)};ROS3D.Highlighter=function(a){this.hoverObjs=[];this.onMouseOver=function(b){this.hoverObjs.push(b.currentTarget)};this.onMouseOut=function(b){this.hoverObjs.splice(this.hoverObjs.indexOf(b.currentTarget),1)};this.getWebglObjects=function(f,e,d){var b=f.__webglObjects;for(var h=0;h<e.length;h++){if(e[h]){for(var g=b.length-1;g>=0;g--){if(b[g].object===e[h]){d.push(b[g]);break}}this.getWebglObjects(f,e[h].children,d)}}};this.renderHighlight=function(d,e,b){var c=[];this.getWebglObjects(e,this.hoverObjs,c);e.overrideMaterial=new THREE.MeshBasicMaterial({fog:false,opacity:0.5,depthTest:true,depthWrite:false,polygonOffset:true,polygonOffsetUnits:-1,side:THREE.DoubleSide});var f=e.__webglObjects;e.__webglObjects=c;d.render(e,b);e.__webglObjects=f;e.overrideMaterial=null};a.addEventListener("mouseover",this.onMouseOver.bind(this));a.addEventListener("mouseout",this.onMouseOut.bind(this))};ROS3D.MouseHandler=function(c,a,b,e){THREE.EventDispatcher.call(this);this.camera=a;this.rootObj=b;this.renderer=c;this.fallbackTarget=e;this.lastTarget=e;this.dragging=false;this.projector=new THREE.Projector();var d=["contextmenu","click","dblclick","mouseout","mousedown","mouseup","mousemove","mousewheel","DOMMouseScroll","touchstart","touchend","touchcancel","touchleave","touchmove"];this.listeners={};this.processDomEvent=function(q){q.preventDefault();var r=q.target;var t=r.getBoundingClientRect();var m=q.clientX-t.left-r.clientLeft+r.scrollLeft;var s=q.clientY-t.top-r.clientTop+r.scrollTop;var h=m/r.clientWidth*2-1;var f=-s/r.clientHeight*2+1;var l=new THREE.Vector3(h,f,0.5);this.projector.unprojectVector(l,this.camera);var p=new THREE.Raycaster(this.camera.position.clone(),l.sub(this.camera.position).normalize());var u=p.ray;var g={mousePos:new THREE.Vector2(h,f),mouseRay:u,domEvent:q,camera:this.camera,intersection:this.lastIntersection};if(q.type=="mouseout"){if(this.dragging){this.notify(this.lastTarget,"mouseup",g);this.dragging=false}this.notify(this.lastTarget,"mouseout",g);this.lastTarget=null;return}if(this.dragging){this.notify(this.lastTarget,q.type,g);if((q.type==="mouseup"&&q.button===2)||q.type==="click"){this.dragging=false}return}var r=this.lastTarget;var k=[];k=p.intersectObject(this.rootObj,true);if(k.length>0){r=k[0].object;g.intersection=this.lastIntersection=k[0]}else{r=this.fallbackTarget}if(r!==this.lastTarget){var o=this.notify(r,"mouseover",g);if(o){this.notify(this.lastTarget,"mouseout",g)}else{r=this.fallbackTarget;if(r!==this.lastTarget){this.notify(r,"mouseover",g);this.notify(this.lastTarget,"mouseout",g)}}}this.notify(r,q.type,g);if(q.type==="mousedown"){this.dragging=true}this.lastTarget=r};this.notify=function(h,g,f){f.type=g;f.cancelBubble=false;f.stopPropagation=function(){f.cancelBubble=true};f.currentTarget=h;while(f.currentTarget){if(f.currentTarget.dispatchEvent&&f.currentTarget.dispatchEvent instanceof Function){f.currentTarget.dispatchEvent(f);if(f.cancelBubble){this.dispatchEvent(f);return true}}f.currentTarget=f.currentTarget.parent}return false};this.destroy=function(){this.listeners.forEach(function(f){this.renderer.domElement.removeEventListener(eventName,f,false)},this)};d.forEach(function(f){this.listeners[f]=this.processDomEvent.bind(this);this.renderer.domElement.addEventListener(f,this.listeners[f],false)},this)};ROS3D.OrbitControls=function(A,H){THREE.EventDispatcher.call(this);this.object=H;this.object.up=new THREE.Vector3(0,0,1);this.center=new THREE.Vector3();this.userZoom=true;this.userZoomSpeed=1;this.userRotate=true;this.userRotateSpeed=1;this.autoRotate=false;this.autoRotateSpeed=2;var d=this;var v=0.000001;var E=1800;var z=new THREE.Vector2();var g=new THREE.Vector2();var t=new THREE.Vector2();var y=new THREE.Vector2();var G=new THREE.Vector2();var q=new THREE.Vector2();var o=new THREE.Vector3();var r=new THREE.Vector3();var c=new THREE.Vector3();var b=new THREE.Vector3();var k=0;var C=0;var F=1;var u=new THREE.Vector3();var x={NONE:-1,ROTATE:0,ZOOM:1,MOVE:2};var h=x.NONE;function l(){return 2*Math.PI/60/60*d.autoRotateSpeed}function w(){return Math.pow(0.95,d.userZoomSpeed)}function D(K,I,L){var J=new THREE.Vector3();var M=new THREE.Vector3();J.subVectors(I,K.origin);dot=K.direction.dot(L);if(Math.abs(dot)<K.precision){return null}scalar=L.dot(J)/dot;M=K.direction.clone().multiplyScalar(scalar);return M}this.axes=new ROS3D.Axes({shaftRadius:0.025,headRadius:0.07,headLength:0.2});A.add(this.axes);this.axes.traverse(function(I){I.visible=false});this.showAxes=function(){d.axes.traverse(function(I){I.visible=true});if(this.hideTimeout){clearTimeout(this.hideTimeout)}d.hideTimeout=setTimeout(function(){d.axes.traverse(function(I){I.visible=false});d.hideTimeout=false},1000)};var B={type:"change"};function m(I){var J=I.domEvent;J.preventDefault();switch(J.button){case 0:h=x.ROTATE;z.set(J.clientX,J.clientY);break;case 1:h=x.MOVE;r=new THREE.Vector3(0,0,1);var K=new THREE.Matrix4().extractRotation(H.matrix);r.applyMatrix4(K);o=d.center.clone();c=d.object.position.clone();b=D(I.mouseRay,o,r);break;case 2:h=x.ZOOM;y.set(J.clientX,J.clientY);break}this.showAxes()}function s(I){var J=I.domEvent;if(h===x.ROTATE){g.set(J.clientX,J.clientY);t.subVectors(g,z);d.rotateLeft(2*Math.PI*t.x/E*d.userRotateSpeed);d.rotateUp(2*Math.PI*t.y/E*d.userRotateSpeed);z.copy(g);this.showAxes()}else{if(h===x.ZOOM){G.set(J.clientX,J.clientY);q.subVectors(G,y);if(q.y>0){d.zoomIn()}else{d.zoomOut()}y.copy(G);this.showAxes()}else{if(h===x.MOVE){var L=D(I.mouseRay,d.center,r);if(!L){return}var K=new THREE.Vector3().subVectors(b.clone(),L.clone());d.center.addVectors(o.clone(),K.clone());d.object.position.addVectors(c.clone(),K.clone());d.update();d.object.updateMatrixWorld();this.showAxes()}}}}function e(I){if(!d.userRotate){return}h=x.NONE}function p(I){if(!d.userZoom){return}var J=I.domEvent;if(typeof(J.wheelDelta)!=="undefined"){var K=J.wheelDelta}else{var K=-J.detail}if(K>0){d.zoomOut()}else{d.zoomIn()}this.showAxes()}function a(I){m(I);I.preventDefault()}function f(I){s(I);I.preventDefault()}this.rotateLeft=function(I){if(I===undefined){I=l()}C-=I};this.rotateRight=function(I){if(I===undefined){I=l()}C+=I};this.rotateUp=function(I){if(I===undefined){I=l()}k-=I};this.rotateDown=function(I){if(I===undefined){I=l()}k+=I};this.zoomIn=function(I){if(I===undefined){I=w()}F/=I};this.zoomOut=function(I){if(I===undefined){I=w()}F*=I};this.update=function(){var J=this.object.position;var M=J.clone().sub(this.center);var K=Math.atan2(M.y,M.x);var L=Math.atan2(Math.sqrt(M.y*M.y+M.x*M.x),M.z);if(this.autoRotate){this.rotateLeft(l())}K+=C;L+=k;L=Math.max(v,Math.min(Math.PI-v,L));var I=M.length();M.y=I*Math.sin(L)*Math.sin(K);M.z=I*Math.cos(L);M.x=I*Math.sin(L)*Math.cos(K);M.multiplyScalar(F);J.copy(this.center).add(M);this.object.lookAt(this.center);I=M.length();this.axes.position=this.center.clone();this.axes.scale.x=this.axes.scale.y=this.axes.scale.z=I*0.05;this.axes.updateMatrixWorld(true);C=0;k=0;F=1;if(u.distanceTo(this.object.position)>0){this.dispatchEvent(B);u.copy(this.object.position)}};this.addEventListener("mousedown",m);this.addEventListener("mouseup",e);this.addEventListener("mousemove",s);this.addEventListener("touchstart",a);this.addEventListener("touchmove",f);this.addEventListener("mousewheel",p);this.addEventListener("DOMMouseScroll",p)};ROS3D.InteractiveMarker=function(d,b,a){THREE.Object3D.call(this);THREE.EventDispatcher.call(this);var c=this;this.name=d.name;this.dragging=false;this.onServerSetPose({pose:d.pose});this.dragStart={position:new THREE.Vector3(),orientation:new THREE.Quaternion(),positionWorld:new THREE.Vector3(),orientationWorld:new THREE.Quaternion(),event3d:{}};d.controls.forEach(function(e){c.add(new ROS3D.InteractiveMarkerControl(c,e,b,a))});if(d.menuEntries.length>0){this.menu=new ROS3D.InteractiveMarkerMenu(d.menuEntries);this.menu.addEventListener("menu_select",function(e){c.dispatchEvent(e)})}};ROS3D.InteractiveMarker.prototype=Object.create(THREE.Object3D.prototype);var projector=new THREE.Projector();var findClosestPoint=function(p,c){var h=new THREE.Vector3;h.subVectors(p.origin,c.origin);var f=c.direction.clone();var b=p.direction.clone();var d=h.dot(f);var e=f.dot(b);var a=h.dot(b);var m=f.dot(f);var g=b.dot(b);var l=g*m-e*e;if(Math.abs(l)<=0.0001){return undefined}var k=d*e-a*m;var o=k/l;return o};var closestAxisPoint=function(a,k,p){var c=a.origin.clone();projector.projectVector(c,k);var g=a.direction.clone().add(a.origin);projector.projectVector(g,k);var l=g.clone().sub(c);var h=new THREE.Vector2;var q=h.subVectors(p,c).dot(l)/l.dot(l);var f=new THREE.Vector2;f.addVectors(c,l.clone().multiplyScalar(q));var e=new THREE.Vector3(f.x,f.y,0.5);projector.unprojectVector(e,k);var b=new THREE.Ray(k.position,e.sub(k.position).normalize());var m=findClosestPoint(a,b,m);return m};var intersectPlane=function(d,a,e){var b=new THREE.Vector3();var c=new THREE.Vector3();b.subVectors(a,d.origin);dot=d.direction.dot(e);if(Math.abs(dot)<d.precision){return null}scalar=e.dot(b)/dot;c.addVectors(d.origin,d.direction.clone().multiplyScalar(scalar));return c};ROS3D.InteractiveMarker.prototype.showMenu=function(b,a){if(this.menu){this.menu.show(b,a)}};ROS3D.InteractiveMarker.prototype.moveAxis=function(e,h,f){if(this.dragging){var d=e.currentControlOri;var c=h.clone().applyQuaternion(d);var g=this.dragStart.event3d.intersection.point;var l=c.clone().applyQuaternion(this.dragStart.orientationWorld.clone());var a=new THREE.Ray(g,l);var k=closestAxisPoint(a,f.camera,f.mousePos);var b=new THREE.Vector3;b.addVectors(this.dragStart.position,c.clone().applyQuaternion(this.dragStart.orientation).multiplyScalar(k));this.setPosition(e,b);f.stopPropagation()}};ROS3D.InteractiveMarker.prototype.movePlane=function(d,g,h){if(this.dragging){var c=d.currentControlOri;var f=g.clone().applyQuaternion(c);var k=this.dragStart.event3d.intersection.point;var e=f.clone().applyQuaternion(this.dragStart.orientationWorld);var a=intersectPlane(h.mouseRay,k,e);var b=new THREE.Vector3;b.subVectors(a,k);b.add(this.dragStart.positionWorld);this.setPosition(d,b);h.stopPropagation()}};function printVec(a){}function printQuat(a){}ROS3D.InteractiveMarker.prototype.rotateAxis=function(l,g,c){if(this.dragging){l.updateMatrixWorld();var r=l.currentControlOri;var e=r.clone().multiply(g.clone());printQuat(r);printQuat(e);var u=(new THREE.Vector3(1,0,0)).applyQuaternion(e);var o=this.dragStart.event3d.intersection.point;var f=u.applyQuaternion(this.dragStart.orientationWorld);printVec(u);printVec(f);var k=intersectPlane(c.mouseRay,o,f);var b=new THREE.Ray(this.dragStart.positionWorld,f);var d=intersectPlane(b,o,f);var m=this.dragStart.orientationWorld.clone().multiply(e);var q=m.clone().inverse();k.sub(d);k.applyQuaternion(q);var p=this.dragStart.event3d.intersection.point.clone();p.sub(d);p.applyQuaternion(q);var v=Math.atan2(k.y,k.z);var t=Math.atan2(p.y,p.z);var s=t-v;var h=new THREE.Quaternion();h.setFromAxisAngle(u,s);this.setOrientation(l,h.multiply(this.dragStart.orientationWorld));c.stopPropagation()}};ROS3D.InteractiveMarker.prototype.feedbackEvent=function(a,b){this.dispatchEvent({type:a,position:this.position.clone(),orientation:this.quaternion.clone(),controlName:b.name})};ROS3D.InteractiveMarker.prototype.startDrag=function(b,a){if(a.domEvent.button!==0){return}a.stopPropagation();this.dragging=true;this.updateMatrixWorld(true);var c=new THREE.Vector3();this.matrixWorld.decompose(this.dragStart.positionWorld,this.dragStart.orientationWorld,c);this.dragStart.position=this.position.clone();this.dragStart.orientation=this.quaternion.clone();this.dragStart.event3d=a;this.feedbackEvent("user_mouse_down",b)};ROS3D.InteractiveMarker.prototype.stopDrag=function(b,a){if(a.domEvent.button!==0){return}a.stopPropagation();this.dragging=false;this.dragStart.event3d={};this.onServerSetPose(this.bufferedPoseEvent);this.bufferedPoseEvent=undefined;this.feedbackEvent("user_mouse_up",b)};ROS3D.InteractiveMarker.prototype.buttonClick=function(b,a){a.stopPropagation();this.feedbackEvent("user_button_click",b)};ROS3D.InteractiveMarker.prototype.setPosition=function(b,a){this.position=a;this.feedbackEvent("user_changed_pose",b)};ROS3D.InteractiveMarker.prototype.setOrientation=function(b,a){a.normalize();this.quaternion=a;this.feedbackEvent("user_changed_pose",b)};ROS3D.InteractiveMarker.prototype.onServerSetPose=function(a){if(a===undefined){return}if(this.dragging){this.bufferedPoseEvent=a;return}var b=a.pose;this.position.x=b.position.x;this.position.y=b.position.y;this.position.z=b.position.z;this.useQuaternion=true;this.quaternion=new THREE.Quaternion(b.orientation.x,b.orientation.y,b.orientation.z,b.orientation.w);this.updateMatrixWorld(true)};ROS3D.InteractiveMarkerControl=function(l,o,t,q){THREE.Object3D.call(this);THREE.EventDispatcher.call(this);this.parent=l;this.dragging=false;var g=this;this.name=o.name;var k=0;var h=1;var c=2;var f=3;var e=4;var r=5;var w=6;var d=new THREE.Quaternion(o.orientation.x,o.orientation.y,o.orientation.z,o.orientation.w);d.normalize();var b=new THREE.Vector3(1,0,0);b.applyQuaternion(d);this.currentControlOri=new THREE.Quaternion();switch(o.interaction_mode){case f:this.addEventListener("mousemove",l.moveAxis.bind(l,this,b));this.addEventListener("touchmove",l.moveAxis.bind(l,this,b));break;case r:this.addEventListener("mousemove",l.rotateAxis.bind(l,this,d));break;case e:this.addEventListener("mousemove",l.movePlane.bind(l,this,b));break;case c:this.addEventListener("click",l.buttonClick.bind(l,this));break;default:break}function m(y){y.stopPropagation()}if(o.interaction_mode!=k){this.addEventListener("mousedown",l.startDrag.bind(l,this));this.addEventListener("mouseup",l.stopDrag.bind(l,this));this.addEventListener("contextmenu",l.showMenu.bind(l,this));this.addEventListener("mouseover",m);this.addEventListener("mouseout",m);this.addEventListener("click",m);this.addEventListener("touchstart",function(y){console.log(y.domEvent);if(y.domEvent.touches.length==1){y.type="mousedown";y.domEvent.button=0;g.dispatchEvent(y)}});this.addEventListener("touchmove",function(y){if(y.domEvent.touches.length==1){console.log(y.domEvent);y.type="mousemove";y.domEvent.button=0;g.dispatchEvent(y)}});this.addEventListener("touchend",function(y){if(y.domEvent.touches.length==0){y.domEvent.button=0;y.type="mouseup";g.dispatchEvent(y);y.type="click";g.dispatchEvent(y)}})}var v=0;var u=1;var p=2;var a=new THREE.Quaternion();var s=l.position.clone().multiplyScalar(-1);switch(o.orientation_mode){case v:a=l.quaternion.clone().inverse();g.updateMatrixWorld=function(y){ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(g,y);g.currentControlOri.copy(g.quaternion);g.currentControlOri.normalize()};break;case u:g.updateMatrixWorld=function(y){g.useQuaternion=true;g.quaternion=g.parent.quaternion.clone().inverse();g.updateMatrix();g.matrixWorldNeedsUpdate=true;ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(g,y);g.currentControlOri.copy(g.quaternion)};break;case p:var x=o.independent_marker_orientation;g.updateMatrixWorld=function(A){t.updateMatrixWorld();var D=new THREE.Matrix4().extractRotation(t.matrixWorld);var B=new THREE.Matrix4();var z=Math.PI*0.5;var C=new THREE.Vector3(-z,0,z);B.setRotationFromEuler(C);var y=new THREE.Matrix4();y.getInverse(g.parent.matrixWorld);D.multiplyMatrices(D,B);D.multiplyMatrices(y,D);g.currentControlOri.setFromRotationMatrix(D);if(!x){g.useQuaternion=true;g.quaternion.copy(g.currentControlOri);g.updateMatrix();g.matrixWorldNeedsUpdate=true}ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(g,A)};break;default:break}o.markers.forEach(function(z){var y=new ROS3D.Marker({message:z,path:q});if(z.header.frame_id!==""){y.position.add(s);y.position.applyQuaternion(a);y.quaternion.multiplyQuaternions(a,y.quaternion);y.updateMatrixWorld()}g.add(y)})};ROS3D.InteractiveMarkerControl.prototype=Object.create(THREE.Object3D.prototype);ROS3D.InteractiveMarkerMenu=function(e){var c=[];c[0]={children:[]};THREE.EventDispatcher.call(this);var f=this;this.menuDomElem=document.createElement("div");this.menuDomElem.style.position="absolute";this.menuDomElem.className="interactive_marker_menu";this.menuDomElem.addEventListener("contextmenu",function(m){m.preventDefault()});this.overlayDomElem=document.createElement("div");this.overlayDomElem.className="interactive_marker_overlay";this.hideListener=this.hide.bind(this);this.overlayDomElem.addEventListener("contextmenu",this.hideListener);this.overlayDomElem.addEventListener("click",this.hideListener);for(var d=0;d<e.length;d++){var k=e[d];var a=k.id;c[a]={title:k.title,id:a,children:[]}}for(var d=0;d<e.length;d++){var k=e[d];var a=k.id;var b=c[a];var l=c[k.parent_id];l.children.push(b)}function g(o,m){this.dispatchEvent({type:"menu_select",domEvent:m,id:o.id,controlName:this.controlName});this.hide(m)}function h(q,m){var r=document.createElement("ul");q.appendChild(r);var p=m.children;for(var o=0;o<p.length;o++){var t=document.createElement("li");var s=document.createElement("div");s.appendChild(document.createTextNode(p[o].title));r.appendChild(t);t.appendChild(s);if(p[o].children.length>0){h(t,p[o]);s.addEventListener("click",f.hide.bind(f))}else{s.addEventListener("click",g.bind(f,p[o]));s.className="interactive_marker_menuentry"}}}h(this.menuDomElem,c[0])};ROS3D.InteractiveMarkerMenu.prototype.show=function(b,a){if(a&&a.preventDefault){a.preventDefault()}this.controlName=b.name;this.menuDomElem.style.left=a.domEvent.clientX+"px";this.menuDomElem.style.top=a.domEvent.clientY+"px";document.body.appendChild(this.overlayDomElem);document.body.appendChild(this.menuDomElem)};ROS3D.InteractiveMarkerMenu.prototype.hide=function(a){if(a&&a.preventDefault){a.preventDefault()}document.body.removeChild(this.overlayDomElem);document.body.removeChild(this.menuDomElem)};ROS3D.ColladaLoader=function(){var ao=null;var J=null;var Z;var aL=null;var ac={};var m={};var R={};var ah={};var at={};var T={};var av={};var ag={};var aP;var aJ;var aS;var f;var M;var v=true;var S=THREE.SmoothShading;var ae={centerGeometry:false,convertUpAxis:false,subdivideFaces:true,upAxis:"Y",defaultEnvMap:null};var aR=1;var aw="Y";var B=null;var C=Math.PI/180;function g(a1,a5,a4){var a3=0;if(document.implementation&&document.implementation.createDocument){var a2=new XMLHttpRequest();a2.onreadystatechange=function(){if(a2.readyState==4){if(a2.status==0||a2.status==200){if(a2.responseXML){aL=a5;an(a2.responseXML,undefined,a1)}else{if(a2.responseText){aL=a5;var a6=new DOMParser();var a7=a6.parseFromString(a2.responseText,"application/xml");an(a7,undefined,a1)}else{console.error("ColladaLoader: Empty or non-existing file ("+a1+")")}}}}else{if(a2.readyState==3){if(a4){if(a3==0){a3=a2.getResponseHeader("Content-Length")}a4({total:a3,loaded:a2.responseText.length})}}}};a2.open("GET",a1,true);a2.send(null)}else{alert("Don't know how to parse XML!")}}function an(a6,a4,a2){ao=a6;a4=a4||aL;if(a2!==undefined){var a5=a2.split("/");a5.pop();aS=(a5.length<1?".":a5.join("/"))+"/"}A();X();m=aA("//dae:library_images/dae:image",af,"image");T=aA("//dae:library_materials/dae:material",c,"material");av=aA("//dae:library_effects/dae:effect",Q,"effect");at=aA("//dae:library_geometries/dae:geometry",aC,"geometry");ag=aA(".//dae:library_cameras/dae:camera",aQ,"camera");ah=aA("//dae:library_controllers/dae:controller",L,"controller");R=aA("//dae:library_animations/dae:animation",aT,"animation");aJ=aA(".//dae:library_visual_scenes/dae:visual_scene",aM,"visual_scene");f=[];M=[];Z=aa();J=new THREE.Object3D();for(var a3=0;a3<Z.nodes.length;a3++){J.add(d(Z.nodes[a3]))}x();var a1={scene:J,morphs:f,skins:M,animations:aP,dae:{images:m,materials:T,cameras:ag,effects:av,geometries:at,controllers:ah,animations:R,visualScenes:aJ,scene:Z}};if(a4){a4(a1)}return a1}function F(a1){S=a1}function A(){var a4=ao.evaluate("//dae:asset",ao,aX,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);var a2=a4.iterateNext();if(a2&&a2.childNodes){for(var a1=0;a1<a2.childNodes.length;a1++){var a5=a2.childNodes[a1];switch(a5.nodeName){case"unit":var a3=a5.getAttribute("meter");if(a3){aR=parseFloat(a3)}break;case"up_axis":aw=a5.textContent.charAt(0);break}}}}function aA(a7,a4,a6){var a5=ao.evaluate(a7,ao,aX,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);var a8={};var a3=a5.iterateNext();var a2=0;while(a3){var a1=(new a4()).parse(a3);if(!a1.id||a1.id.length==0){a1.id=a6+(a2++)}a8[a1.id]=a1;a3=a5.iterateNext()}return a8}function aa(){var a2=ao.evaluate(".//dae:scene/dae:instance_visual_scene",ao,aX,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext();if(a2){var a1=a2.getAttribute("url").replace(/^#/,"");return aJ[a1.length>0?a1:"visual_scene0"]}else{return null}}function x(){aP=[];r(J)}function r(a6){var a8=Z.getChildById(a6.name,true),a5=null;if(a8&&a8.keys){a5={fps:60,hierarchy:[{node:a8,keys:a8.keys,sids:a8.sids}],node:a6,name:"animation_"+a6.name,length:0};aP.push(a5);for(var a4=0,a1=a8.keys.length;a4<a1;a4++){a5.length=Math.max(a5.length,a8.keys[a4].time)}}else{a5={hierarchy:[{keys:[],sids:[]}]}}for(var a4=0,a1=a6.children.length;a4<a1;a4++){var a7=r(a6.children[a4]);for(var a2=0,a3=a7.hierarchy.length;a2<a3;a2++){a5.hierarchy.push({keys:[],sids:[]})}}return a5}function K(){var a7=1000000;var a1=-a7;var a5=0;for(var a6 in R){var a4=R[a6];for(var a3=0;a3<a4.sampler.length;a3++){var a2=a4.sampler[a3];a2.create();a7=Math.min(a7,a2.startTime);a1=Math.max(a1,a2.endTime);a5=Math.max(a5,a2.input.length)}}return{start:a7,end:a1,frames:a5}}function p(a8,a5){var a7=a5 instanceof G?ah[a5.url]:a5;if(!a7||!a7.morph){console.log("could not find morph controller!");return}var a4=a7.morph;for(var a3=0;a3<a4.targets.length;a3++){var a2=a4.targets[a3];var a1=at[a2];if(!a1.mesh||!a1.mesh.primitives||!a1.mesh.primitives.length){continue}var a6=a1.mesh.primitives[0].geometry;if(a6.vertices.length===a8.vertices.length){a8.morphTargets.push({name:"target_1",vertices:a6.vertices})}}a8.morphTargets.push({name:"target_Z",vertices:a8.vertices})}function aN(a8,a1,a6){var a2=ah[a1.url];if(!a2||!a2.skin){console.log("could not find skin controller!");return}if(!a1.skeleton||!a1.skeleton.length){console.log("could not find the skeleton for the skin!");return}var a9=a2.skin;var a4=Z.getChildById(a1.skeleton[0]);var a7=[];a6=a6!==undefined?a6:true;var a3=[];a8.skinWeights=[];a8.skinIndices=[];if(a6){for(var a5=0;a5<a8.vertices.length;a5++){a9.bindShapeMatrix.multiplyVector3(a8.vertices[a5])}}}function E(a6,a2,a7,a4){a6.world=a6.world||new THREE.Matrix4();a6.world.copy(a6.matrix);if(a6.channels&&a6.channels.length){var a5=a6.channels[0];var a1=a5.sampler.output[a7];if(a1 instanceof THREE.Matrix4){a6.world.copy(a1)}}if(a4){a6.world.multiply(a4,a6.world)}a2.push(a6);for(var a3=0;a3<a6.nodes.length;a3++){E(a6.nodes[a3],a2,a7,a6.world)}}function V(a1,a8){for(var a4=0;a4<a1.length;a4++){var a7=a1[a4];var a9=-1;if(a7.type!="JOINT"){continue}for(var a3=0;a3<a8.joints.length;a3++){if(a7.sid==a8.joints[a3]){a9=a3;break}}if(a9>=0){var a5=a8.invBindMatrices[a9];a7.invBindMatrix=a5;a7.skinningMatrix=new THREE.Matrix4();a7.skinningMatrix.multiply(a7.world,a5);a7.weights=[];for(var a3=0;a3<a8.weights.length;a3++){for(var a2=0;a2<a8.weights[a3].length;a2++){var a6=a8.weights[a3][a2];if(a6.joint==a9){a7.weights.push(a6)}}}}else{throw"ColladaLoader: Could not find joint '"+a7.sid+"'."}}}function aU(bc,bd,a3){var ba=ah[bd.url];a3=a3!==undefined?a3:40;if(!ba||!ba.skin){console.log("ColladaLoader: Could not find skin controller.");return}if(!bd.skeleton||!bd.skeleton.length){console.log("ColladaLoader: Could not find the skeleton for the skin. ");return}var a9=K();var a5=Z.getChildById(bd.skeleton[0],true)||Z.getChildBySid(bd.skeleton[0],true);var a7,a6,be,a1,a8;var bf=new THREE.Vector3(),a2,bg;for(a7=0;a7<bc.vertices.length;a7++){ba.skin.bindShapeMatrix.multiplyVector3(bc.vertices[a7])}for(a3=0;a3<a9.frames;a3++){var a4=[];var bb=[];for(a7=0;a7<bc.vertices.length;a7++){bb.push(new THREE.Vector3())}E(a5,a4,a3);V(a4,ba.skin);for(a7=0;a7<a4.length;a7++){if(a4[a7].type!="JOINT"){continue}for(a6=0;a6<a4[a7].weights.length;a6++){be=a4[a7].weights[a6];a1=be.index;a8=be.weight;a2=bc.vertices[a1];bg=bb[a1];bf.x=a2.x;bf.y=a2.y;bf.z=a2.z;a4[a7].skinningMatrix.multiplyVector3(bf);bg.x+=(bf.x*a8);bg.y+=(bf.y*a8);bg.z+=(bf.z*a8)}}bc.morphTargets.push({name:"target_"+a3,vertices:bb})}}function d(bp,bb){var bg=new THREE.Object3D();var be=false;var a9;var bk;var bs,bq;for(bs=0;bs<bp.controllers.length;bs++){var bm=ah[bp.controllers[bs].url];switch(bm.type){case"skin":if(at[bm.skin.source]){var bi=new ay();bi.url=bm.skin.source;bi.instance_material=bp.controllers[bs].instance_material;bp.geometries.push(bi);be=true;a9=bp.controllers[bs]}else{if(ah[bm.skin.source]){var bw=ah[bm.skin.source];bk=bw;if(bw.morph&&at[bw.morph.source]){var bi=new ay();bi.url=bw.morph.source;bi.instance_material=bp.controllers[bs].instance_material;bp.geometries.push(bi)}}}break;case"morph":if(at[bm.morph.source]){var bi=new ay();bi.url=bm.morph.source;bi.instance_material=bp.controllers[bs].instance_material;bp.geometries.push(bi);bk=bp.controllers[bs]}console.log("ColladaLoader: Morph-controller partially supported.");default:break}}var a4={};for(bs=0;bs<bp.geometries.length;bs++){var br=bp.geometries[bs];var bc=br.instance_material;var a6=at[br.url];var a8={};var bu=[];var bh=0;var a3;if(a6){if(!a6.mesh||!a6.mesh.primitives){continue}if(bg.name.length==0){bg.name=a6.id}if(bc){for(bq=0;bq<bc.length;bq++){var bl=bc[bq];var bt=T[bl.target];var a7=bt.instance_effect.url;var a1=av[a7].shader;var bn=a1.material;if(a6.doubleSided){if(!(bn in a4)){var bd=bn.clone();bd.side=THREE.DoubleSide;a4[bn]=bd}bn=a4[bn]}bn.opacity=!bn.opacity?1:bn.opacity;a8[bl.symbol]=bh;bu.push(bn);a3=bn;a3.name=bt.name==null||bt.name===""?bt.id:bt.name;bh++}}var a2;var bf=a3||new THREE.MeshLambertMaterial({color:14540253,shading:THREE.FlatShading,side:a6.doubleSided?THREE.DoubleSide:THREE.FrontSide});var bo=a6.mesh.geometry3js;if(bh>1){bf=new THREE.MeshFaceMaterial(bu);for(bq=0;bq<bo.faces.length;bq++){var ba=bo.faces[bq];ba.materialIndex=a8[ba.daeMaterial]}}if(a9!==undefined){aU(bo,a9);bf.morphTargets=true;a2=new THREE.SkinnedMesh(bo,bf,false);a2.skeleton=a9.skeleton;a2.skinController=ah[a9.url];a2.skinInstanceController=a9;a2.name="skin_"+M.length;M.push(a2)}else{if(bk!==undefined){p(bo,bk);bf.morphTargets=true;a2=new THREE.Mesh(bo,bf);a2.name="morph_"+f.length;f.push(a2)}else{a2=new THREE.Mesh(bo,bf)}}bp.geometries.length>1?bg.add(a2):bg=a2}}for(bs=0;bs<bp.cameras.length;bs++){var bj=bp.cameras[bs];var bx=ag[bj.url];bg=new THREE.PerspectiveCamera(bx.fov,bx.aspect_ratio,bx.znear,bx.zfar)}bg.name=bp.id||"";bg.matrix=bp.matrix;var a5=bp.matrix.decompose();bg.position=a5[0];bg.quaternion=a5[1];bg.useQuaternion=true;bg.scale=a5[2];bg.position.multiplyScalar(aR);bg.scale.multiplyScalar(aR);if(ae.centerGeometry&&bg.geometry){var bv=THREE.GeometryUtils.center(bg.geometry);bg.quaternion.multiplyVector3(bv.multiply(bg.scale));bg.position.sub(bv)}for(bs=0;bs<bp.nodes.length;bs++){bg.add(d(bp.nodes[bs],bp))}return bg}function q(a2,a3){for(var a1=0;a1<a2.joints.length;a1++){if(a2.joints[a1]==a3){return a1}}}function N(a1){return ao.evaluate(".//dae:library_nodes//dae:node[@id='"+a1+"']",ao,aX,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext()}function t(a3){var a6=[];var a2=1000000;var a7=-1000000;for(var a1 in R){var a4=R[a1];for(var a5=0;a5<a4.channel.length;a5++){var a8=a4.channel[a5];var a9=a4.sampler[a5];var a1=a8.target.split("/")[0];if(a1==a3.id){a9.create();a8.sampler=a9;a2=Math.min(a2,a9.startTime);a7=Math.max(a7,a9.endTime);a6.push(a8)}}}if(a6.length){a3.startTime=a2;a3.endTime=a7}return a6}function aW(a6){var a4=10000000;for(var a3=0;a3<a6.channels.length;a3++){var a2=a6.channels[a3].sampler;for(var a1=0;a1<a2.input.length-1;a1++){var a7=a2.input[a1];var a5=a2.input[a1+1];a4=Math.min(a4,a5-a7)}}return a4}function ad(a2,ba){var a3={};var a5,a4;for(a5=0;a5<a2.channels.length;a5++){var a6=a2.channels[a5];a3[a6.sid]=a6}var a8=new THREE.Matrix4();for(a5=0;a5<a2.transforms.length;a5++){var a1=a2.transforms[a5];var a6=a3[a1.sid];if(a6!==undefined){var a7=a6.sampler;var a9;for(a4=0;a4<a7.input.length-1;a4++){if(a7.input[a4+1]>ba){a9=a7.output[a4];break}}if(a9!==undefined){if(a9 instanceof THREE.Matrix4){a8=a8.multiply(a8,a9)}else{a8=a8.multiply(a8,a1.matrix)}}else{a8=a8.multiply(a8,a1.matrix)}}else{a8=a8.multiply(a8,a1.matrix)}}return a8}function aG(bb){if(bb.channels&&bb.channels.length){var a9=[],bf=[];for(var bd=0,a6=bb.channels.length;bd<a6;bd++){var bi=bb.channels[bd],a1=bi.fullSid,ba=bi.sampler,a7=ba.input,a8=bb.getTransformBySid(bi.sid),a2;if(bi.arrIndices){a2=[];for(var bc=0,be=bi.arrIndices.length;bc<be;bc++){a2[bc]=aB(bi.arrIndices[bc])}}else{a2=W(bi.member)}if(a8){if(bf.indexOf(a1)===-1){bf.push(a1)}for(var bc=0,be=a7.length;bc<be;bc++){var a5=a7[bc],bg=ba.getData(a8.type,bc),bh=aq(a9,a5);if(!bh){bh=new ai(a5);var a4=y(a9,a5);a9.splice(a4==-1?a9.length:a4,0,bh)}bh.addTarget(a1,a8,a2,bg)}}else{console.log('Could not find transform "'+bi.sid+'" in node '+bb.id)}}for(var bd=0;bd<bf.length;bd++){var a3=bf[bd];for(var bc=0;bc<a9.length;bc++){var bh=a9[bc];if(!bh.hasTarget(a3)){w(a9,bh,bc,a3)}}}bb.keys=a9;bb.sids=bf}}function aq(a4,a6){var a5=null;for(var a3=0,a1=a4.length;a3<a1&&a5==null;a3++){var a2=a4[a3];if(a2.time===a6){a5=a2}else{if(a2.time>a6){break}}}return a5}function y(a5,a6){var a2=-1;for(var a4=0,a1=a5.length;a4<a1&&a2==-1;a4++){var a3=a5[a4];if(a3.time>=a6){a2=a4}}return a2}function w(bb,a8,a9,a6){var bc=az(bb,a6,a9?a9-1:0),a7=l(bb,a6,a9+1);if(bc&&a7){var a2=(a8.time-bc.time)/(a7.time-bc.time),ba=bc.getTarget(a6),a5=a7.getTarget(a6).data,a1=ba.data,a4;if(ba.type==="matrix"){a4=a1}else{if(a1.length){a4=[];for(var a3=0;a3<a1.length;++a3){a4[a3]=a1[a3]+(a5[a3]-a1[a3])*a2}}else{a4=a1+(a5-a1)*a2}}a8.addTarget(a6,ba.transform,ba.member,a4)}}function l(a3,a4,a1){for(;a1<a3.length;a1++){var a2=a3[a1];if(a2.hasTarget(a4)){return a2}}return null}function az(a3,a4,a1){a1=a1>=0?a1:a1+a3.length;for(;a1>=0;a1--){var a2=a3[a1];if(a2.hasTarget(a4)){return a2}}return null}function af(){this.id="";this.init_from=""}af.prototype.parse=function(a2){this.id=a2.getAttribute("id");for(var a1=0;a1<a2.childNodes.length;a1++){var a3=a2.childNodes[a1];if(a3.nodeName=="init_from"){this.init_from=a3.textContent}}return this};function L(){this.id="";this.name="";this.type="";this.skin=null;this.morph=null}L.prototype.parse=function(a2){this.id=a2.getAttribute("id");this.name=a2.getAttribute("name");this.type="none";for(var a1=0;a1<a2.childNodes.length;a1++){var a3=a2.childNodes[a1];switch(a3.nodeName){case"skin":this.skin=(new s()).parse(a3);this.type=a3.nodeName;break;case"morph":this.morph=(new k()).parse(a3);this.type=a3.nodeName;break;default:break}}return this};function k(){this.method=null;this.source=null;this.targets=null;this.weights=null}k.prototype.parse=function(a5){var a3={};var a1=[];var a4;this.method=a5.getAttribute("method");this.source=a5.getAttribute("source").replace(/^#/,"");for(a4=0;a4<a5.childNodes.length;a4++){var a7=a5.childNodes[a4];if(a7.nodeType!=1){continue}switch(a7.nodeName){case"source":var a6=(new aO()).parse(a7);a3[a6.id]=a6;break;case"targets":a1=this.parseInputs(a7);break;default:console.log(a7.nodeName);break}}for(a4=0;a4<a1.length;a4++){var a2=a1[a4];var a6=a3[a2.source];switch(a2.semantic){case"MORPH_TARGET":this.targets=a6.read();break;case"MORPH_WEIGHT":this.weights=a6.read();break;default:break}}return this};k.prototype.parseInputs=function(a3){var a1=[];for(var a2=0;a2<a3.childNodes.length;a2++){var a4=a3.childNodes[a2];if(a4.nodeType!=1){continue}switch(a4.nodeName){case"input":a1.push((new a()).parse(a4));break;default:break}}return a1};function s(){this.source="";this.bindShapeMatrix=null;this.invBindMatrices=[];this.joints=[];this.weights=[]}s.prototype.parse=function(a4){var a2={};var a1,a5;this.source=a4.getAttribute("source").replace(/^#/,"");this.invBindMatrices=[];this.joints=[];this.weights=[];for(var a3=0;a3<a4.childNodes.length;a3++){var a8=a4.childNodes[a3];if(a8.nodeType!=1){continue}switch(a8.nodeName){case"bind_shape_matrix":var a6=e(a8.textContent);this.bindShapeMatrix=am(a6);break;case"source":var a7=new aO().parse(a8);a2[a7.id]=a7;break;case"joints":a1=a8;break;case"vertex_weights":a5=a8;break;default:console.log(a8.nodeName);break}}this.parseJoints(a1,a2);this.parseWeights(a5,a2);return this};s.prototype.parseJoints=function(a4,a2){for(var a3=0;a3<a4.childNodes.length;a3++){var a6=a4.childNodes[a3];if(a6.nodeType!=1){continue}switch(a6.nodeName){case"input":var a1=(new a()).parse(a6);var a5=a2[a1.source];if(a1.semantic=="JOINT"){this.joints=a5.read()}else{if(a1.semantic=="INV_BIND_MATRIX"){this.invBindMatrices=a5.read()}}break;default:break}}};s.prototype.parseWeights=function(a6,a1){var bf,bc,a9=[];for(var a7=0;a7<a6.childNodes.length;a7++){var a2=a6.childNodes[a7];if(a2.nodeType!=1){continue}switch(a2.nodeName){case"input":a9.push((new a()).parse(a2));break;case"v":bf=aV(a2.textContent);break;case"vcount":bc=aV(a2.textContent);break;default:break}}var ba=0;for(var a7=0;a7<bc.length;a7++){var a4=bc[a7];var a8=[];for(var a5=0;a5<a4;a5++){var bb={};for(var a3=0;a3<a9.length;a3++){var bd=a9[a3];var be=bf[ba+bd.offset];switch(bd.semantic){case"JOINT":bb.joint=be;break;case"WEIGHT":bb.weight=a1[bd.source].data[be];break;default:break}}a8.push(bb);ba+=a9.length}for(var a5=0;a5<a8.length;a5++){a8[a5].index=a7}this.weights.push(a8)}};function aM(){this.id="";this.name="";this.nodes=[];this.scene=new THREE.Object3D()}aM.prototype.getChildById=function(a4,a1){for(var a2=0;a2<this.nodes.length;a2++){var a3=this.nodes[a2].getChildById(a4,a1);if(a3){return a3}}return null};aM.prototype.getChildBySid=function(a1,a2){for(var a3=0;a3<this.nodes.length;a3++){var a4=this.nodes[a3].getChildBySid(a1,a2);if(a4){return a4}}return null};aM.prototype.parse=function(a2){this.id=a2.getAttribute("id");this.name=a2.getAttribute("name");this.nodes=[];for(var a1=0;a1<a2.childNodes.length;a1++){var a3=a2.childNodes[a1];if(a3.nodeType!=1){continue}switch(a3.nodeName){case"node":this.nodes.push((new aD()).parse(a3));break;default:break}}return this};function aD(){this.id="";this.name="";this.sid="";this.nodes=[];this.controllers=[];this.transforms=[];this.geometries=[];this.channels=[];this.matrix=new THREE.Matrix4()}aD.prototype.getChannelForTransform=function(bb){for(var a7=0;a7<this.channels.length;a7++){var a8=this.channels[a7];var a5=a8.target.split("/");var a1=a5.shift();var a2=a5.shift();var a9=(a2.indexOf(".")>=0);var ba=(a2.indexOf("(")>=0);var a4;var a6;if(a9){a5=a2.split(".");a2=a5.shift();a6=a5.shift()}else{if(ba){a4=a2.split("(");a2=a4.shift();for(var a3=0;a3<a4.length;a3++){a4[a3]=parseInt(a4[a3].replace(/\)/,""))}}}if(a2==bb){a8.info={sid:a2,dotSyntax:a9,arrSyntax:ba,arrIndices:a4};return a8}}return null};aD.prototype.getChildById=function(a4,a1){if(this.id==a4){return this}if(a1){for(var a2=0;a2<this.nodes.length;a2++){var a3=this.nodes[a2].getChildById(a4,a1);if(a3){return a3}}}return null};aD.prototype.getChildBySid=function(a1,a2){if(this.sid==a1){return this}if(a2){for(var a3=0;a3<this.nodes.length;a3++){var a4=this.nodes[a3].getChildBySid(a1,a2);if(a4){return a4}}}return null};aD.prototype.getTransformBySid=function(a1){for(var a2=0;a2<this.transforms.length;a2++){if(this.transforms[a2].sid==a1){return this.transforms[a2]}}return null};aD.prototype.parse=function(a3){var a1;this.id=a3.getAttribute("id");this.sid=a3.getAttribute("sid");this.name=a3.getAttribute("name");this.type=a3.getAttribute("type");this.type=this.type=="JOINT"?this.type:"NODE";this.nodes=[];this.transforms=[];this.geometries=[];this.cameras=[];this.controllers=[];this.matrix=new THREE.Matrix4();for(var a2=0;a2<a3.childNodes.length;a2++){var a5=a3.childNodes[a2];if(a5.nodeType!=1){continue}switch(a5.nodeName){case"node":this.nodes.push((new aD()).parse(a5));break;case"instance_camera":this.cameras.push((new ax()).parse(a5));break;case"instance_controller":this.controllers.push((new G()).parse(a5));break;case"instance_geometry":this.geometries.push((new ay()).parse(a5));break;case"instance_light":break;case"instance_node":a1=a5.getAttribute("url").replace(/^#/,"");var a4=N(a1);if(a4){this.nodes.push((new aD()).parse(a4))}break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new aI()).parse(a5));break;case"extra":break;default:console.log(a5.nodeName);break}}this.channels=t(this);aG(this);this.updateMatrix();return this};aD.prototype.updateMatrix=function(){this.matrix.identity();for(var a1=0;a1<this.transforms.length;a1++){this.transforms[a1].apply(this.matrix)}};function aI(){this.sid="";this.type="";this.data=[];this.obj=null}aI.prototype.parse=function(a1){this.sid=a1.getAttribute("sid");this.type=a1.nodeName;this.data=e(a1.textContent);this.convert();return this};aI.prototype.convert=function(){switch(this.type){case"matrix":this.obj=am(this.data);break;case"rotate":this.angle=this.data[3]*C;case"translate":U(this.data,-1);this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":U(this.data,1);this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type);break}};aI.prototype.apply=function(a1){switch(this.type){case"matrix":a1.multiply(this.obj);break;case"translate":a1.translate(this.obj);break;case"rotate":a1.rotateByAxis(this.obj,this.angle);break;case"scale":a1.scale(this.obj);break}};aI.prototype.update=function(a3,a4){var a1=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(!a4){this.obj.copy(a3)}else{if(a4.length===1){switch(a4[0]){case 0:this.obj.n11=a3[0];this.obj.n21=a3[1];this.obj.n31=a3[2];this.obj.n41=a3[3];break;case 1:this.obj.n12=a3[0];this.obj.n22=a3[1];this.obj.n32=a3[2];this.obj.n42=a3[3];break;case 2:this.obj.n13=a3[0];this.obj.n23=a3[1];this.obj.n33=a3[2];this.obj.n43=a3[3];break;case 3:this.obj.n14=a3[0];this.obj.n24=a3[1];this.obj.n34=a3[2];this.obj.n44=a3[3];break}}else{if(a4.length===2){var a2="n"+(a4[0]+1)+(a4[1]+1);this.obj[a2]=a3}else{console.log("Incorrect addressing of matrix in transform.")}}}break;case"translate":case"scale":if(Object.prototype.toString.call(a4)==="[object Array]"){a4=a1[a4[0]]}switch(a4){case"X":this.obj.x=a3;break;case"Y":this.obj.y=a3;break;case"Z":this.obj.z=a3;break;default:this.obj.x=a3[0];this.obj.y=a3[1];this.obj.z=a3[2];break}break;case"rotate":if(Object.prototype.toString.call(a4)==="[object Array]"){a4=a1[a4[0]]}switch(a4){case"X":this.obj.x=a3;break;case"Y":this.obj.y=a3;break;case"Z":this.obj.z=a3;break;case"ANGLE":this.angle=a3*C;break;default:this.obj.x=a3[0];this.obj.y=a3[1];this.obj.z=a3[2];this.angle=a3[3]*C;break}break}};function G(){this.url="";this.skeleton=[];this.instance_material=[]}G.prototype.parse=function(a3){this.url=a3.getAttribute("url").replace(/^#/,"");this.skeleton=[];this.instance_material=[];for(var a2=0;a2<a3.childNodes.length;a2++){var a5=a3.childNodes[a2];if(a5.nodeType!==1){continue}switch(a5.nodeName){case"skeleton":this.skeleton.push(a5.textContent.replace(/^#/,""));break;case"bind_material":var a4=ao.evaluate(".//dae:instance_material",a5,aX,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(a4){var a1=a4.iterateNext();while(a1){this.instance_material.push((new h()).parse(a1));a1=a4.iterateNext()}}break;case"extra":break;default:break}}return this};function h(){this.symbol="";this.target=""}h.prototype.parse=function(a1){this.symbol=a1.getAttribute("symbol");this.target=a1.getAttribute("target").replace(/^#/,"");return this};function ay(){this.url="";this.instance_material=[]}ay.prototype.parse=function(a3){this.url=a3.getAttribute("url").replace(/^#/,"");this.instance_material=[];for(var a2=0;a2<a3.childNodes.length;a2++){var a5=a3.childNodes[a2];if(a5.nodeType!=1){continue}if(a5.nodeName=="bind_material"){var a4=ao.evaluate(".//dae:instance_material",a5,aX,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(a4){var a1=a4.iterateNext();while(a1){this.instance_material.push((new h()).parse(a1));a1=a4.iterateNext()}}break}}return this};function aC(){this.id="";this.mesh=null}aC.prototype.parse=function(a2){this.id=a2.getAttribute("id");aH(this,a2);for(var a1=0;a1<a2.childNodes.length;a1++){var a3=a2.childNodes[a1];switch(a3.nodeName){case"mesh":this.mesh=(new al(this)).parse(a3);break;case"extra":break;default:break}}return this};function al(a1){this.geometry=a1.id;this.primitives=[];this.vertices=null;this.geometry3js=null}al.prototype.parse=function(a5){this.primitives=[];var a4,a3;for(a4=0;a4<a5.childNodes.length;a4++){var a6=a5.childNodes[a4];switch(a6.nodeName){case"source":aY(a6);break;case"vertices":this.vertices=(new ak()).parse(a6);break;case"triangles":this.primitives.push((new ab().parse(a6)));break;case"polygons":this.primitives.push((new D().parse(a6)));break;case"polylist":this.primitives.push((new aE().parse(a6)));break;default:break}}this.geometry3js=new THREE.Geometry();var a2=ac[this.vertices.input.POSITION.source].data;for(a4=0;a4<a2.length;a4+=3){this.geometry3js.vertices.push(Y(a2,a4).clone())}for(a4=0;a4<this.primitives.length;a4++){var a1=this.primitives[a4];a1.setVertices(this.vertices);this.handlePrimitive(a1,this.geometry3js)}this.geometry3js.computeCentroids();this.geometry3js.computeFaceNormals();if(this.geometry3js.calcNormals){this.geometry3js.computeVertexNormals();delete this.geometry3js.calcNormals}this.geometry3js.computeBoundingBox();return this};al.prototype.handlePrimitive=function(a8,a3){var bq,bp,bj=a8.p,bd=a8.inputs;var a1,bi,a4;var bc,bo;var bm=0,bk=3,bg=0;var by=[];for(bq=0;bq<bd.length;bq++){a1=bd[bq];var bl=a1.offset+1;bg=(bg<bl)?bl:bg;switch(a1.semantic){case"TEXCOORD":by.push(a1.set);break}}for(var ba=0;ba<bj.length;++ba){var bn=bj[ba],bs=0;while(bs<bn.length){var a7=[];var br=[];var bw=null;var be=[];if(a8.vcount){bk=a8.vcount.length?a8.vcount[bm++]:a8.vcount}else{bk=bn.length/bg}for(bq=0;bq<bk;bq++){for(bp=0;bp<bd.length;bp++){a1=bd[bp];bc=ac[a1.source];bi=bn[bs+(bq*bg)+a1.offset];bo=bc.accessor.params.length;a4=bi*bo;switch(a1.semantic){case"VERTEX":a7.push(bi);break;case"NORMAL":br.push(Y(bc.data,a4));break;case"TEXCOORD":bw=bw||{};if(bw[a1.set]===undefined){bw[a1.set]=[]}bw[a1.set].push(new THREE.Vector2(bc.data[a4],bc.data[a4+1]));break;case"COLOR":be.push(new THREE.Color().setRGB(bc.data[a4],bc.data[a4+1],bc.data[a4+2]));break;default:break}}}if(br.length==0){a1=this.vertices.input.NORMAL;if(a1){bc=ac[a1.source];bo=bc.accessor.params.length;for(var a9=0,bb=a7.length;a9<bb;a9++){br.push(Y(bc.data,a7[a9]*bo))}}else{a3.calcNormals=true}}if(!bw){bw={};a1=this.vertices.input.TEXCOORD;if(a1){by.push(a1.set);bc=ac[a1.source];bo=bc.accessor.params.length;for(var a9=0,bb=a7.length;a9<bb;a9++){a4=a7[a9]*bo;if(bw[a1.set]===undefined){bw[a1.set]=[]}bw[a1.set].push(new THREE.Vector2(bc.data[a4],1-bc.data[a4+1]))}}}if(be.length==0){a1=this.vertices.input.COLOR;if(a1){bc=ac[a1.source];bo=bc.accessor.params.length;for(var a9=0,bb=a7.length;a9<bb;a9++){a4=a7[a9]*bo;be.push(new THREE.Color().setRGB(bc.data[a4],bc.data[a4+1],bc.data[a4+2]))}}}var a5=null,a6=[],bh,bf;if(bk===3){a6.push(new THREE.Face3(a7[0],a7[1],a7[2],br,be.length?be:new THREE.Color()))}else{if(bk===4){a6.push(new THREE.Face4(a7[0],a7[1],a7[2],a7[3],br,be.length?be:new THREE.Color()))}else{if(bk>4&&ae.subdivideFaces){var a2=be.length?be:new THREE.Color(),bv,bu,bt,bA,bz,bx;for(bp=1;bp<bk-1;){a6.push(new THREE.Face3(a7[0],a7[bp],a7[bp+1],[br[0],br[bp++],br[bp]],a2))}}}}if(a6.length){for(var a9=0,bb=a6.length;a9<bb;a9++){a5=a6[a9];a5.daeMaterial=a8.material;a3.faces.push(a5);for(bp=0;bp<by.length;bp++){bh=bw[by[bp]];if(bk>4){bf=[bh[0],bh[a9+1],bh[a9+2]]}else{if(bk===4){bf=[bh[0],bh[1],bh[2],bh[3]]}else{bf=[bh[0],bh[1],bh[2]]}}if(!a3.faceVertexUvs[bp]){a3.faceVertexUvs[bp]=[]}a3.faceVertexUvs[bp].push(bf)}}}else{console.log("dropped face with vcount "+bk+" for geometry with id: "+a3.id)}bs+=bg*bk}}};function D(){this.material="";this.count=0;this.inputs=[];this.vcount=null;this.p=[];this.geometry=new THREE.Geometry()}D.prototype.setVertices=function(a1){for(var a2=0;a2<this.inputs.length;a2++){if(this.inputs[a2].source==a1.id){this.inputs[a2].source=a1.input.POSITION.source}}};D.prototype.parse=function(a2){this.material=a2.getAttribute("material");this.count=o(a2,"count",0);for(var a1=0;a1<a2.childNodes.length;a1++){var a3=a2.childNodes[a1];switch(a3.nodeName){case"input":this.inputs.push((new a()).parse(a2.childNodes[a1]));break;case"vcount":this.vcount=aV(a3.textContent);break;case"p":this.p.push(aV(a3.textContent));break;case"ph":console.warn("polygon holes not yet supported!");break;default:break}}return this};function aE(){D.call(this);this.vcount=[]}aE.prototype=Object.create(D.prototype);function ab(){D.call(this);this.vcount=3}ab.prototype=Object.create(D.prototype);function aF(){this.source="";this.count=0;this.stride=0;this.params=[]}aF.prototype.parse=function(a2){this.params=[];this.source=a2.getAttribute("source");this.count=o(a2,"count",0);this.stride=o(a2,"stride",0);for(var a1=0;a1<a2.childNodes.length;a1++){var a4=a2.childNodes[a1];if(a4.nodeName=="param"){var a3={};a3.name=a4.getAttribute("name");a3.type=a4.getAttribute("type");this.params.push(a3)}}return this};function ak(){this.input={}}ak.prototype.parse=function(a3){this.id=a3.getAttribute("id");for(var a2=0;a2<a3.childNodes.length;a2++){if(a3.childNodes[a2].nodeName=="input"){var a1=(new a()).parse(a3.childNodes[a2]);this.input[a1.semantic]=a1}}return this};function a(){this.semantic="";this.offset=0;this.source="";this.set=0}a.prototype.parse=function(a1){this.semantic=a1.getAttribute("semantic");this.source=a1.getAttribute("source").replace(/^#/,"");this.set=o(a1,"set",-1);this.offset=o(a1,"offset",0);if(this.semantic=="TEXCOORD"&&this.set<0){this.set=0}return this};function aO(a1){this.id=a1;this.type=null}aO.prototype.parse=function(a3){this.id=a3.getAttribute("id");for(var a2=0;a2<a3.childNodes.length;a2++){var a4=a3.childNodes[a2];switch(a4.nodeName){case"bool_array":this.data=aj(a4.textContent);this.type=a4.nodeName;break;case"float_array":this.data=e(a4.textContent);this.type=a4.nodeName;break;case"int_array":this.data=aV(a4.textContent);this.type=a4.nodeName;break;case"IDREF_array":case"Name_array":this.data=I(a4.textContent);this.type=a4.nodeName;break;case"technique_common":for(var a1=0;a1<a4.childNodes.length;a1++){if(a4.childNodes[a1].nodeName=="accessor"){this.accessor=(new aF()).parse(a4.childNodes[a1]);break}}break;default:break}}return this};aO.prototype.read=function(){var a2=[];var a5=this.accessor.params[0];switch(a5.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var a3=0;a3<this.data.length;a3+=16){var a4=this.data.slice(a3,a3+16);var a1=am(a4);a2.push(a1)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+a5.type+".");break}return a2};function c(){this.id="";this.name="";this.instance_effect=null}c.prototype.parse=function(a2){this.id=a2.getAttribute("id");this.name=a2.getAttribute("name");for(var a1=0;a1<a2.childNodes.length;a1++){if(a2.childNodes[a1].nodeName=="instance_effect"){this.instance_effect=(new z()).parse(a2.childNodes[a1]);break}}return this};function ap(){this.color=new THREE.Color(0);this.color.setRGB(Math.random(),Math.random(),Math.random());this.color.a=1;this.texture=null;this.texcoord=null;this.texOpts=null}ap.prototype.isColor=function(){return(this.texture==null)};ap.prototype.isTexture=function(){return(this.texture!=null)};ap.prototype.parse=function(a3){for(var a2=0;a2<a3.childNodes.length;a2++){var a4=a3.childNodes[a2];if(a4.nodeType!=1){continue}switch(a4.nodeName){case"color":var a1=e(a4.textContent);this.color=new THREE.Color(0);this.color.setRGB(a1[0],a1[1],a1[2]);this.color.a=a1[3];break;case"texture":this.texture=a4.getAttribute("texture");this.texcoord=a4.getAttribute("texcoord");this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1};this.parseTexture(a4);break;default:break}}return this};ap.prototype.parseTexture=function(a2){if(!a2.childNodes){return this}if(a2.childNodes[1]&&a2.childNodes[1].nodeName==="extra"){a2=a2.childNodes[1];if(a2.childNodes[1]&&a2.childNodes[1].nodeName==="technique"){a2=a2.childNodes[1]}}for(var a1=0;a1<a2.childNodes.length;a1++){var a3=a2.childNodes[a1];switch(a3.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[a3.nodeName]=parseFloat(a3.textContent);break;case"wrapU":case"wrapV":this.texOpts[a3.nodeName]=parseInt(a3.textContent);break;default:this.texOpts[a3.nodeName]=a3.textContent;break}}return this};function au(a2,a1){this.type=a2;this.effect=a1;this.material=null}au.prototype.parse=function(a2){for(var a1=0;a1<a2.childNodes.length;a1++){var a4=a2.childNodes[a1];if(a4.nodeType!=1){continue}switch(a4.nodeName){case"ambient":case"emission":case"diffuse":case"specular":case"transparent":this[a4.nodeName]=(new ap()).parse(a4);break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var a3=ar(a4,".//dae:float");if(a3.length>0){this[a4.nodeName]=parseFloat(a3[0].textContent)}break;default:break}}this.create();return this};au.prototype.create=function(){var a6={};var a9=(this["transparency"]!==undefined&&this["transparency"]<1);for(var a1 in this){switch(a1){case"ambient":case"emission":case"diffuse":case"specular":var a8=this[a1];if(a8 instanceof ap){if(a8.isTexture()){var a2=a8.texture;var a7=this.effect.sampler[a2].source;if(a7){var a3=this.effect.surface[a7];var a4=m[a3.init_from];if(a4){var a5=THREE.ImageUtils.loadTexture(aS+a4.init_from);a5.wrapS=a8.texOpts.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;a5.wrapT=a8.texOpts.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;a5.offset.x=a8.texOpts.offsetU;a5.offset.y=a8.texOpts.offsetV;a5.repeat.x=a8.texOpts.repeatU;a5.repeat.y=a8.texOpts.repeatV;a6.map=a5;if(a1==="emission"){a6.emissive=16777215}}}}else{if(a1==="diffuse"||!a9){if(a1==="emission"){a6.emissive=a8.color.getHex()}else{a6[a1]=a8.color.getHex()}}}}break;case"shininess":a6[a1]=this[a1];break;case"reflectivity":a6[a1]=this[a1];if(a6[a1]>0){a6.envMap=ae.defaultEnvMap}a6.combine=THREE.MixOperation;break;case"index_of_refraction":a6.refractionRatio=this[a1];if(this[a1]!==1){a6.envMap=ae.defaultEnvMap}break;case"transparency":if(a9){a6.transparent=true;a6.opacity=this[a1];a9=true}break;default:break}}a6.shading=S;a6.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide;switch(this.type){case"constant":if(a6.emissive!=undefined){a6.color=a6.emissive}this.material=new THREE.MeshBasicMaterial(a6);break;case"phong":case"blinn":if(a6.diffuse!=undefined){a6.color=a6.diffuse}this.material=new THREE.MeshPhongMaterial(a6);break;case"lambert":default:if(a6.diffuse!=undefined){a6.color=a6.diffuse}this.material=new THREE.MeshLambertMaterial(a6);break}return this.material};function b(a1){this.effect=a1;this.init_from=null;this.format=null}b.prototype.parse=function(a2){for(var a1=0;a1<a2.childNodes.length;a1++){var a3=a2.childNodes[a1];if(a3.nodeType!=1){continue}switch(a3.nodeName){case"init_from":this.init_from=a3.textContent;break;case"format":this.format=a3.textContent;break;default:console.log("unhandled Surface prop: "+a3.nodeName);break}}return this};function P(a1){this.effect=a1;this.source=null;this.wrap_s=null;this.wrap_t=null;this.minfilter=null;this.magfilter=null;this.mipfilter=null}P.prototype.parse=function(a2){for(var a1=0;a1<a2.childNodes.length;a1++){var a3=a2.childNodes[a1];if(a3.nodeType!=1){continue}switch(a3.nodeName){case"source":this.source=a3.textContent;break;case"minfilter":this.minfilter=a3.textContent;break;case"magfilter":this.magfilter=a3.textContent;break;case"mipfilter":this.mipfilter=a3.textContent;break;case"wrap_s":this.wrap_s=a3.textContent;break;case"wrap_t":this.wrap_t=a3.textContent;break;default:console.log("unhandled Sampler2D prop: "+a3.nodeName);break}}return this};function Q(){this.id="";this.name="";this.shader=null;this.surface={};this.sampler={}}Q.prototype.create=function(){if(this.shader==null){return null}};Q.prototype.parse=function(a2){this.id=a2.getAttribute("id");this.name=a2.getAttribute("name");aH(this,a2);this.shader=null;for(var a1=0;a1<a2.childNodes.length;a1++){var a3=a2.childNodes[a1];if(a3.nodeType!=1){continue}switch(a3.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(a3));break;default:break}}return this};Q.prototype.parseNewparam=function(a3){var a1=a3.getAttribute("sid");for(var a2=0;a2<a3.childNodes.length;a2++){var a4=a3.childNodes[a2];if(a4.nodeType!=1){continue}switch(a4.nodeName){case"surface":this.surface[a1]=(new b(this)).parse(a4);break;case"sampler2D":this.sampler[a1]=(new P(this)).parse(a4);break;case"extra":break;default:console.log(a4.nodeName);break}}};Q.prototype.parseProfileCOMMON=function(a3){var a4;for(var a2=0;a2<a3.childNodes.length;a2++){var a5=a3.childNodes[a2];if(a5.nodeType!=1){continue}switch(a5.nodeName){case"profile_COMMON":this.parseProfileCOMMON(a5);break;case"technique":a4=a5;break;case"newparam":this.parseNewparam(a5);break;case"image":var a1=(new af()).parse(a5);m[a1.id]=a1;break;case"extra":break;default:console.log(a5.nodeName);break}}return a4};Q.prototype.parseTechnique=function(a2){for(var a1=0;a1<a2.childNodes.length;a1++){var a3=a2.childNodes[a1];if(a3.nodeType!=1){continue}switch(a3.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=(new au(a3.nodeName,this)).parse(a3);break;default:break}}};function z(){this.url=""}z.prototype.parse=function(a1){this.url=a1.getAttribute("url").replace(/^#/,"");return this};function aT(){this.id="";this.name="";this.source={};this.sampler=[];this.channel=[]}aT.prototype.parse=function(a3){this.id=a3.getAttribute("id");this.name=a3.getAttribute("name");this.source={};for(var a2=0;a2<a3.childNodes.length;a2++){var a6=a3.childNodes[a2];if(a6.nodeType!=1){continue}switch(a6.nodeName){case"animation":var a4=(new aT()).parse(a6);for(var a5 in a4.source){this.source[a5]=a4.source[a5]}for(var a1=0;a1<a4.channel.length;a1++){this.channel.push(a4.channel[a1]);this.sampler.push(a4.sampler[a1])}break;case"source":var a5=(new aO()).parse(a6);this.source[a5.id]=a5;break;case"sampler":this.sampler.push((new H(this)).parse(a6));break;case"channel":this.channel.push((new O(this)).parse(a6));break;default:break}}return this};function O(a1){this.animation=a1;this.source="";this.target="";this.fullSid=null;this.sid=null;this.dotSyntax=null;this.arrSyntax=null;this.arrIndices=null;this.member=null}O.prototype.parse=function(a3){this.source=a3.getAttribute("source").replace(/^#/,"");this.target=a3.getAttribute("target");var a5=this.target.split("/");var a8=a5.shift();var a1=a5.shift();var a7=(a1.indexOf(".")>=0);var a4=(a1.indexOf("(")>=0);if(a7){a5=a1.split(".");this.sid=a5.shift();this.member=a5.shift()}else{if(a4){var a6=a1.split("(");this.sid=a6.shift();for(var a2=0;a2<a6.length;a2++){a6[a2]=parseInt(a6[a2].replace(/\)/,""))}this.arrIndices=a6}else{this.sid=a1}}this.fullSid=a1;this.dotSyntax=a7;this.arrSyntax=a4;return this};function H(a1){this.id="";this.animation=a1;this.inputs=[];this.input=null;this.output=null;this.strideOut=null;this.interpolation=null;this.startTime=null;this.endTime=null;this.duration=0}H.prototype.parse=function(a2){this.id=a2.getAttribute("id");this.inputs=[];for(var a1=0;a1<a2.childNodes.length;a1++){var a3=a2.childNodes[a1];if(a3.nodeType!=1){continue}switch(a3.nodeName){case"input":this.inputs.push((new a()).parse(a3));break;default:break}}return this};H.prototype.create=function(){for(var a2=0;a2<this.inputs.length;a2++){var a1=this.inputs[a2];var a3=this.animation.source[a1.source];switch(a1.semantic){case"INPUT":this.input=a3.read();break;case"OUTPUT":this.output=a3.read();this.strideOut=a3.accessor.stride;break;case"INTERPOLATION":this.interpolation=a3.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(a1.semantic);break}}this.startTime=0;this.endTime=0;this.duration=0;if(this.input.length){this.startTime=100000000;this.endTime=-100000000;for(var a2=0;a2<this.input.length;a2++){this.startTime=Math.min(this.startTime,this.input[a2]);this.endTime=Math.max(this.endTime,this.input[a2])}this.duration=this.endTime-this.startTime}};H.prototype.getData=function(a3,a1){var a4;if(a3==="matrix"&&this.strideOut===16){a4=this.output[a1]}else{if(this.strideOut>1){a4=[];a1*=this.strideOut;for(var a2=0;a2<this.strideOut;++a2){a4[a2]=this.output[a1+a2]}if(this.strideOut===3){switch(a3){case"rotate":case"translate":U(a4,-1);break;case"scale":U(a4,1);break}}else{if(this.strideOut===4&&a3==="matrix"){U(a4,-1)}}}else{a4=this.output[a1]}}return a4};function ai(a1){this.targets=[];this.time=a1}ai.prototype.addTarget=function(a4,a1,a3,a2){this.targets.push({sid:a4,member:a3,transform:a1,data:a2})};ai.prototype.apply=function(a1){for(var a2=0;a2<this.targets.length;++a2){var a3=this.targets[a2];if(!a1||a3.sid===a1){a3.transform.update(a3.data,a3.member)}}};ai.prototype.getTarget=function(a2){for(var a1=0;a1<this.targets.length;++a1){if(this.targets[a1].sid===a2){return this.targets[a1]}}return null};ai.prototype.hasTarget=function(a2){for(var a1=0;a1<this.targets.length;++a1){if(this.targets[a1].sid===a2){return true}}return false};ai.prototype.interpolate=function(ba,a3){for(var a7=0;a7<this.targets.length;++a7){var a9=this.targets[a7],a1=ba.getTarget(a9.sid),a6;if(a9.transform.type!=="matrix"&&a1){var a4=(a3-this.time)/(ba.time-this.time),a8=a1.data,a2=a9.data;if(a4<0||a4>1){console.log("Key.interpolate: Warning! Scale out of bounds:"+a4);a4=a4<0?0:1}if(a2.length){a6=[];for(var a5=0;a5<a2.length;++a5){a6[a5]=a2[a5]+(a8[a5]-a2[a5])*a4}}else{a6=a2+(a8-a2)*a4}}else{a6=a9.data}a9.transform.update(a6,a9.member)}};function aQ(){this.id="";this.name="";this.technique=""}aQ.prototype.parse=function(a2){this.id=a2.getAttribute("id");this.name=a2.getAttribute("name");for(var a1=0;a1<a2.childNodes.length;a1++){var a3=a2.childNodes[a1];if(a3.nodeType!=1){continue}switch(a3.nodeName){case"optics":this.parseOptics(a3);break;default:break}}return this};aQ.prototype.parseOptics=function(a5){for(var a4=0;a4<a5.childNodes.length;a4++){if(a5.childNodes[a4].nodeName=="technique_common"){var a7=a5.childNodes[a4];for(var a3=0;a3<a7.childNodes.length;a3++){this.technique=a7.childNodes[a3].nodeName;if(this.technique=="perspective"){var a6=a7.childNodes[a3];for(var a1=0;a1<a6.childNodes.length;a1++){var a8=a6.childNodes[a1];switch(a8.nodeName){case"yfov":this.yfov=a8.textContent;break;case"xfov":this.xfov=a8.textContent;break;case"znear":this.znear=a8.textContent;break;case"zfar":this.zfar=a8.textContent;break;case"aspect_ratio":this.aspect_ratio=a8.textContent;break}}}else{if(this.technique=="orthographic"){var a2=a7.childNodes[a3];for(var a1=0;a1<a2.childNodes.length;a1++){var a8=a2.childNodes[a1];switch(a8.nodeName){case"xmag":this.xmag=a8.textContent;break;case"ymag":this.ymag=a8.textContent;break;case"znear":this.znear=a8.textContent;break;case"zfar":this.zfar=a8.textContent;break;case"aspect_ratio":this.aspect_ratio=a8.textContent;break}}}}}}}return this};function ax(){this.url=""}ax.prototype.parse=function(a1){this.url=a1.getAttribute("url").replace(/^#/,"");return this};function aY(a1){var a2=a1.getAttribute("id");if(ac[a2]!=undefined){return ac[a2]}ac[a2]=(new aO(a2)).parse(a1);return ac[a2]}function aX(a1){if(a1=="dae"){return"http://www.collada.org/2005/11/COLLADASchema"}return null}function aj(a5){var a2=I(a5);var a4=[];for(var a3=0,a1=a2.length;a3<a1;a3++){a4.push((a2[a3]=="true"||a2[a3]=="1")?true:false)}return a4}function e(a5){var a2=I(a5);var a4=[];for(var a3=0,a1=a2.length;a3<a1;a3++){a4.push(parseFloat(a2[a3]))}return a4}function aV(a5){var a2=I(a5);var a4=[];for(var a3=0,a1=a2.length;a3<a1;a3++){a4.push(parseInt(a2[a3],10))}return a4}function I(a1){return(a1.length>0)?u(a1).split(/\s+/):[]}function u(a1){return a1.replace(/^\s+/,"").replace(/\s+$/,"")}function aZ(a3,a2,a1){if(a3.hasAttribute(a2)){return parseFloat(a3.getAttribute(a2))}else{return a1}}function o(a3,a2,a1){if(a3.hasAttribute(a2)){return parseInt(a3.getAttribute(a2),10)}else{return a1}}function aK(a3,a2,a1){if(a3.hasAttribute(a2)){return a3.getAttribute(a2)}else{return a1}}function a0(a3,a1){if(a3===undefined){var a2="0.";while(a2.length<a1+2){a2+="0"}return a2}a1=a1||2;var a4=a3.toString().split(".");a4[1]=a4.length>1?a4[1].substr(0,a1):"0";while(a4[1].length<a1){a4[1]+="0"}return a4.join(".")}function ar(a2,a4){var a5=ao.evaluate(a4,a2,aX,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);var a3=a5.iterateNext();var a1=[];while(a3){a1.push(a3);a3=a5.iterateNext()}return a1}function aH(a3,a1){a3.doubleSided=false;var a2=ao.evaluate(".//dae:extra//dae:double_sided",a1,aX,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(a2){a2=a2.iterateNext();if(a2&&parseInt(a2.textContent,10)===1){a3.doubleSided=true}}}function X(){if(!ae.convertUpAxis||aw===ae.upAxis){B=null}else{switch(aw){case"X":B=ae.upAxis==="Y"?"XtoY":"XtoZ";break;case"Y":B=ae.upAxis==="X"?"YtoX":"YtoZ";break;case"Z":B=ae.upAxis==="X"?"ZtoX":"ZtoY";break}}}function U(a3,a1){if(!ae.convertUpAxis||aw===ae.upAxis){return}switch(B){case"XtoY":var a2=a3[0];a3[0]=a1*a3[1];a3[1]=a2;break;case"XtoZ":var a2=a3[2];a3[2]=a3[1];a3[1]=a3[0];a3[0]=a2;break;case"YtoX":var a2=a3[0];a3[0]=a3[1];a3[1]=a1*a2;break;case"YtoZ":var a2=a3[1];a3[1]=a1*a3[2];a3[2]=a2;break;case"ZtoX":var a2=a3[0];a3[0]=a3[1];a3[1]=a3[2];a3[2]=a2;break;case"ZtoY":var a2=a3[1];a3[1]=a3[2];a3[2]=a1*a2;break}}function Y(a2,a3){var a1=[a2[a3],a2[a3+1],a2[a3+2]];U(a1,-1);return new THREE.Vector3(a1[0],a1[1],a1[2])}function am(a2){if(ae.convertUpAxis){var a1=[a2[0],a2[4],a2[8]];U(a1,-1);a2[0]=a1[0];a2[4]=a1[1];a2[8]=a1[2];a1=[a2[1],a2[5],a2[9]];U(a1,-1);a2[1]=a1[0];a2[5]=a1[1];a2[9]=a1[2];a1=[a2[2],a2[6],a2[10]];U(a1,-1);a2[2]=a1[0];a2[6]=a1[1];a2[10]=a1[2];a1=[a2[0],a2[1],a2[2]];U(a1,-1);a2[0]=a1[0];a2[1]=a1[1];a2[2]=a1[2];a1=[a2[4],a2[5],a2[6]];U(a1,-1);a2[4]=a1[0];a2[5]=a1[1];a2[6]=a1[2];a1=[a2[8],a2[9],a2[10]];U(a1,-1);a2[8]=a1[0];a2[9]=a1[1];a2[10]=a1[2];a1=[a2[3],a2[7],a2[11]];U(a1,-1);a2[3]=a1[0];a2[7]=a1[1];a2[11]=a1[2]}return new THREE.Matrix4(a2[0],a2[1],a2[2],a2[3],a2[4],a2[5],a2[6],a2[7],a2[8],a2[9],a2[10],a2[11],a2[12],a2[13],a2[14],a2[15])}function aB(a2){if(a2>-1&&a2<3){var a1=["X","Y","Z"],a3={X:0,Y:1,Z:2};a2=W(a1[a2]);a2=a3[a2]}return a2}function W(a1){if(ae.convertUpAxis){switch(a1){case"X":switch(B){case"XtoY":case"XtoZ":case"YtoX":a1="Y";break;case"ZtoX":a1="Z";break}break;case"Y":switch(B){case"XtoY":case"YtoX":case"ZtoX":a1="X";break;case"XtoZ":case"YtoZ":case"ZtoY":a1="Z";break}break;case"Z":switch(B){case"XtoZ":a1="X";break;case"YtoZ":case"ZtoX":case"ZtoY":a1="Y";break}break}}return a1}return{load:g,parse:an,setPreferredShading:F,applySkin:aU,geometries:at,options:ae}};ROS3D.MeshLoader=function(a){var a=a||{};this.path=a.path||"";if(this.path.substr(this.path.length-1)!=="/"){this.path+="/"}};ROS3D.MeshLoader.prototype.load=function(f){var c=new THREE.Object3D();var d=this.path+f;var b=d.substr(-4).toLowerCase();if(d.substr(-4).toLowerCase()===".dae"){var a=new ROS3D.ColladaLoader();a.load(d,function e(g){c.add(g.scene)})}return c};ROS3D.UrdfLoader=function(a){var b=this;var a=a||{};this.tfClient=a.tfClient;this.path=a.path||"resources/"};ROS3D.UrdfLoader.prototype.load=function(g){var k=new ROS3D.UrdfModel({string:g});var a=new THREE.Object3D();var m=k.links;var d=new ROS3D.MeshLoader({path:this.path});for(var e in m){var h=m[e];if(h.visual&&h.visual.geometry){if(h.visual.geometry.type===ROS3D.URDF_MESH){var p="/"+h.name;var b=h.visual.geometry.filename;var o=b.substr(-4).toLowerCase();if(o===".dae"){var f=d.load(b.substring(10));var c=new ROS3D.SceneNode({frameID:p,tfClient:this.tfClient,model:f});a.add(c)}}}}return a};ROS3D.ArrowMarker=function(p){var l=p.origin||new THREE.Vector3(0,0,0);var k=p.direction||new THREE.Vector3(1,0,0);var a=p.length||1;var f=p.headLength||0.2;var c=p.shaftDiameter||0.05;var d=p.headDiameter||0.1;var g=p.material||new THREE.MeshBasicMaterial();var e=a-f;var h=new THREE.CylinderGeometry(c*0.5,c*0.5,e,12,1);var b=new THREE.Matrix4;b.setPosition(new THREE.Vector3(0,e*0.5,0));h.applyMatrix(b);var o=new THREE.CylinderGeometry(0,d*0.5,f,12,1);b.setPosition(new THREE.Vector3(0,e+(f*0.5),0));o.applyMatrix(b);THREE.GeometryUtils.merge(h,o);THREE.Mesh.call(this,h,g);this.position=l;this.setDirection(k)};ROS3D.ArrowMarker.prototype=Object.create(THREE.Mesh.prototype);ROS3D.ArrowMarker.prototype.setDirection=function(c){var a=new THREE.Vector3(0,1,0).cross(c);var b=Math.acos(new THREE.Vector3(0,1,0).dot(c.clone().normalize()));this.matrix=new THREE.Matrix4().makeRotationAxis(a.normalize(),b);this.rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder)};ROS3D.ArrowMarker.prototype.setLength=function(a){this.scale.set(a,a,a)};ROS3D.ArrowMarker.prototype.setColor=function(a){this.line.material.color.setHex(a);this.cone.material.color.setHex(a)};ROS3D.Marker=function(f){var h=this;var f=f||{};this.path=f.path||"/";var l=f.message;if(this.path.substr(this.path.length-1)!=="/"){this.path+="/"}function t(F,E,B,C){var D=new THREE.Color();D.setRGB(F,E,B);if(C<=0.99){return new THREE.MeshBasicMaterial({color:D.getHex(),opacity:C+0.1,transparent:true,depthWrite:true,blendSrc:THREE.SrcAlphaFactor,blendDst:THREE.OneMinusSrcAlphaFactor,blendEquation:THREE.ReverseSubtractEquation,blending:THREE.NormalBlending})}else{return new THREE.MeshLambertMaterial({color:D.getHex(),opacity:C,blending:THREE.NormalBlending})}}THREE.Object3D.call(this);this.useQuaternion=true;this.setPose(l.pose);var p=t(l.color.r,l.color.g,l.color.b,l.color.a);switch(l.type){case ROS3D.MARKER_ARROW:var v=l.scale.x;var A=v*0.23;var e=l.scale.y;var z=e*0.5;if(l.points.length===2){var c=new THREE.Vector3(l.points[0].x,l.points[0].y,l.points[0].z);var b=new THREE.Vector3(l.points[1].x,l.points[1].y,l.points[1].z);var y=c.clone().negate().add(b);v=y.length();e=l.scale.y;z=l.scale.x;if(l.scale.z!==0){A=l.scale.z}}this.add(new ROS3D.ArrowMarker({direction:y,origin:c,length:v,headLength:A,shaftDiameter:z,headDiameter:e,material:p}));break;case ROS3D.MARKER_CUBE:var q=new THREE.CubeGeometry(l.scale.x,l.scale.y,l.scale.z);this.add(new THREE.Mesh(q,p));break;case ROS3D.MARKER_SPHERE:var q=new THREE.SphereGeometry(0.5);var a=new THREE.Mesh(q,p);a.scale.x=l.scale.x;a.scale.y=l.scale.y;a.scale.z=l.scale.z;h.add(a);break;case ROS3D.MARKER_CYLINDER:var q=new THREE.CylinderGeometry(0.5,0.5,1,16,1,false);var a=new THREE.Mesh(q,p);a.useQuaternion=true;a.quaternion.setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI*0.5);a.scale=new THREE.Vector3(l.scale.x,l.scale.y,l.scale.z);this.add(a);break;case ROS3D.MARKER_CUBE_LIST:case ROS3D.MARKER_SPHERE_LIST:case ROS3D.MARKER_POINTS:var g=new THREE.Geometry();var m=new THREE.ParticleBasicMaterial({size:l.scale.x});for(var u=0;u<l.points.length;u++){var w=new THREE.Vector3();w.x=l.points[u].x;w.y=l.points[u].y;w.z=l.points[u].z;g.vertices.push(w)}if(l.colors.length==l.points.length){m.vertexColors=true;for(var u=0;u<l.points.length;u++){var r=new THREE.Color();r.setRGB(l.colors[u].r,l.colors[u].g,l.colors[u].b);g.colors.push(r)}}else{m.color.setRGB(l.color.r,l.color.g,l.color.b)}var x=new THREE.ParticleSystem(g,m);this.add(x);break;case ROS3D.MARKER_TEXT_VIEW_FACING:var k=new THREE.TextGeometry(l.text,{size:l.scale.x*0.5,height:0.1*l.scale.x,curveSegments:4,font:"helvetiker",bevelEnabled:false,bevelThickness:2,bevelSize:2,material:0,extrudeMaterial:0});k.computeVertexNormals();k.computeBoundingBox();var a=new THREE.Mesh(k,p);var d=-0.5*(k.boundingBox.max.x-k.boundingBox.min.x);a.position.y=-d;a.rotation.x=Math.PI*0.5;a.rotation.y=Math.PI*1.5;this.add(a);break;case ROS3D.MARKER_MESH_RESOURCE:if(l.mesh_use_embedded_materials){var o=new ROS3D.MeshMarker(l,this.path,false)}else{var o=new ROS3D.MeshMarker(l,this.path,p)}this.add(o);break;case ROS3D.MARKER_TRIANGLE_LIST:var s=new ROS3D.TriangleListMarker(p,l.points,l.colors);s.scale=new THREE.Vector3(l.scale.x,l.scale.y,l.scale.z);this.add(s);break;case ROS3D.MARKER_LINE_STRIP:case ROS3D.MARKER_LINE_LIST:var q=new THREE.CubeGeometry(0.1,0.1,0.1);this.add(new THREE.Mesh(q,p));break;default:console.error("Unknown marker type: "+l.type);break}};ROS3D.Marker.prototype.__proto__=THREE.Object3D.prototype;ROS3D.Marker.prototype.setPose=function(a){this.position.x=a.position.x;this.position.y=a.position.y;this.position.z=a.position.z;this.quaternion=new THREE.Quaternion(a.orientation.x,a.orientation.y,a.orientation.z,a.orientation.w);this.quaternion.normalize();this.updateMatrixWorld()};ROS3D.MeshMarker=function(d,c,b){if(c==undefined){THREE.Mesh.call(this,new THREE.CubeGeometry(0.01,0.01,0.01),new THREE.MeshBasicMaterial())}else{THREE.Mesh.call(this,new THREE.CubeGeometry(0.01,0.01,0.01),new THREE.MeshBasicMaterial());var a=new THREE.ColladaLoader(b);var e=c+d.mesh_resource.substr(10);var f=this;a.load(e,function g(h){var k=h.scene;f.add(k)})}};ROS3D.MeshMarker.prototype=Object.create(THREE.Mesh.prototype);ROS3D.TriangleListMarker=function(d,c,a){THREE.Object3D.call(this);if(d===undefined){d=new THREE.MeshBasicMaterial()}d.side=THREE.DoubleSide;var f=new THREE.Geometry();for(i=0;i<c.length;i++){f.vertices.push(new THREE.Vector3(c[i].x,c[i].y,c[i].z))}if(a.length===c.length){for(i=0;i<c.length;i+=3){var e=new THREE.Face3(i,i+1,i+2);for(j=i*3;j<i*3+3;i++){var b=new THREE.Color();b.setRGB(a[i].r,a[i].g,a[i].b);e.vertexColors.push(b)}f.faces.push(e)}d.vertexColors=THREE.VertexColors}else{if(a.length===c.length/3){for(i=0;i<c.length;i+=3){var e=new THREE.Face3(i,i+1,i+2);e.color.setRGB(a[i/3].r,a[i/3].g,a[i/3].b);f.faces.push(e)}d.vertexColors=THREE.FaceColors}else{for(i=0;i<c.length;i+=3){var e=new THREE.Face3(i,i+1,i+2);f.faces.push(e)}}}f.computeBoundingBox();f.computeBoundingSphere();f.computeCentroids();f.computeFaceNormals();this.mesh=new THREE.Mesh(f,d);this.add(this.mesh)};ROS3D.TriangleListMarker.prototype=Object.create(THREE.Object3D.prototype);ROS3D.TriangleListMarker.prototype.setColor=function(a){this.mesh.material.color.setHex(a)};ROS3D.Axes=function(b){THREE.Object3D.call(this);var c=this;var b=b||{};var e=b.shaftRadius||0.008;var d=b.headRadius||0.023;var a=b.headLength||0.1;function f(m){var k=new THREE.Color;k.setRGB(m.x,m.y,m.z);var l=new THREE.MeshBasicMaterial({color:k.getHex()});var p=new THREE.Vector3;p.crossVectors(m,new THREE.Vector3(0,-1,0));var h=new THREE.Quaternion;h.setFromAxisAngle(p,0.5*Math.PI);var o=new THREE.Mesh(c.headGeom,l);o.position=m.clone();o.position.multiplyScalar(0.95);o.useQuaternion=true;o.quaternion=h;o.updateMatrix();c.add(o);var g=new THREE.Mesh(c.lineGeom,l);g.position=m.clone();g.position.multiplyScalar(0.45);g.useQuaternion=true;g.quaternion=h;g.updateMatrix();c.add(g)}this.lineGeom=new THREE.CylinderGeometry(e,e,1-a);this.headGeom=new THREE.CylinderGeometry(0,d,a);f(new THREE.Vector3(1,0,0));f(new THREE.Vector3(0,1,0));f(new THREE.Vector3(0,0,1))};ROS3D.Axes.prototype.__proto__=THREE.Object3D.prototype;