var ROS3D=ROS3D||{REVISION:"1"};ROS3D.Axes=function(b){var f=this;b=b||{};var d=b.shaftRadius||0.008;var c=b.headRadius||0.023;var a=b.headLength||0.1;THREE.Object3D.call(this);this.lineGeom=new THREE.CylinderGeometry(d,d,1-a);this.headGeom=new THREE.CylinderGeometry(0,c,a);var e=function(k){var i=new THREE.Color;i.setRGB(k.x,k.y,k.z);var j=new THREE.MeshBasicMaterial({color:i.getHex()});var m=new THREE.Vector3;m.crossVectors(k,new THREE.Vector3(0,-1,0));var h=new THREE.Quaternion;h.setFromAxisAngle(m,0.5*Math.PI);var l=new THREE.Mesh(f.headGeom,j);l.position=k.clone();l.position.multiplyScalar(0.95);l.useQuaternion=true;l.quaternion=h;l.updateMatrix();f.add(l);var g=new THREE.Mesh(f.lineGeom,j);g.position=k.clone();g.position.multiplyScalar(0.45);g.useQuaternion=true;g.quaternion=h;g.updateMatrix();f.add(g)};e(new THREE.Vector3(1,0,0));e(new THREE.Vector3(0,1,0));e(new THREE.Vector3(0,0,1))};ROS3D.Axes.prototype=Object.create(THREE.Object3D.prototype);ROS3D.OrbitControls=function(x,E){THREE.EventDispatcher.call(this);this.object=E;this.object.up=new THREE.Vector3(0,0,1);this.center=new THREE.Vector3();this.userZoom=true;this.userZoomSpeed=1;this.userRotate=true;this.userRotateSpeed=1;this.autoRotate=false;this.autoRotateSpeed=2;var d=this;var s=0.000001;var B=1800;var w=new THREE.Vector2();var g=new THREE.Vector2();var q=new THREE.Vector2();var v=new THREE.Vector2();var D=new THREE.Vector2();var n=new THREE.Vector2();var l=new THREE.Vector3();var o=new THREE.Vector3();var c=new THREE.Vector3();var b=new THREE.Vector3();var i=0;var z=0;var C=1;var r=new THREE.Vector3();var u={NONE:-1,ROTATE:0,ZOOM:1,MOVE:2};var h=u.NONE;var j=function(){return 2*Math.PI/60/60*d.autoRotateSpeed};var t=function(){return Math.pow(0.95,d.userZoomSpeed)};var A=function(H,F,I){var G=new THREE.Vector3();var J=new THREE.Vector3();G.subVectors(F,H.origin);dot=H.direction.dot(I);if(Math.abs(dot)<H.precision){return null}scalar=I.dot(G)/dot;J=H.direction.clone().multiplyScalar(scalar);return J};this.axes=new ROS3D.Axes({shaftRadius:0.025,headRadius:0.07,headLength:0.2});x.add(this.axes);this.axes.traverse(function(F){F.visible=false});this.showAxes=function(){d.axes.traverse(function(F){F.visible=true});if(this.hideTimeout){clearTimeout(this.hideTimeout)}d.hideTimeout=setTimeout(function(){d.axes.traverse(function(F){F.visible=false});d.hideTimeout=false},1000)};var y={type:"change"};var k=function(F){var G=F.domEvent;G.preventDefault();switch(G.button){case 0:h=u.ROTATE;w.set(G.clientX,G.clientY);break;case 1:h=u.MOVE;o=new THREE.Vector3(0,0,1);var H=new THREE.Matrix4().extractRotation(E.matrix);o.applyMatrix4(H);l=d.center.clone();c=d.object.position.clone();b=A(F.mouseRay,l,o);break;case 2:h=u.ZOOM;v.set(G.clientX,G.clientY);break}this.showAxes()};var p=function(F){var G=F.domEvent;if(h===u.ROTATE){g.set(G.clientX,G.clientY);q.subVectors(g,w);d.rotateLeft(2*Math.PI*q.x/B*d.userRotateSpeed);d.rotateUp(2*Math.PI*q.y/B*d.userRotateSpeed);w.copy(g);this.showAxes()}else{if(h===u.ZOOM){D.set(G.clientX,G.clientY);n.subVectors(D,v);if(n.y>0){d.zoomIn()}else{d.zoomOut()}v.copy(D);this.showAxes()}else{if(h===u.MOVE){var I=A(F.mouseRay,d.center,o);if(!I){return}var H=new THREE.Vector3().subVectors(b.clone(),I.clone());d.center.addVectors(l.clone(),H.clone());d.object.position.addVectors(c.clone(),H.clone());d.update();d.object.updateMatrixWorld();this.showAxes()}}}};var e=function(F){if(!d.userRotate){return}h=u.NONE};var m=function(F){if(!d.userZoom){return}var G=F.domEvent;if(typeof(G.wheelDelta)!=="undefined"){var H=G.wheelDelta}else{var H=-G.detail}if(H>0){d.zoomOut()}else{d.zoomIn()}this.showAxes()};var a=function(F){k(F);F.preventDefault()};var f=function(F){p(F);F.preventDefault()};this.rotateLeft=function(F){if(F===undefined){F=j()}z-=F};this.rotateRight=function(F){if(F===undefined){F=j()}z+=F};this.rotateUp=function(F){if(F===undefined){F=j()}i-=F};this.rotateDown=function(F){if(F===undefined){F=j()}i+=F};this.zoomIn=function(F){if(F===undefined){F=t()}C/=F};this.zoomOut=function(F){if(F===undefined){F=t()}C*=F};this.update=function(){var G=this.object.position;var J=G.clone().sub(this.center);var H=Math.atan2(J.y,J.x);var I=Math.atan2(Math.sqrt(J.y*J.y+J.x*J.x),J.z);if(this.autoRotate){this.rotateLeft(j())}H+=z;I+=i;I=Math.max(s,Math.min(Math.PI-s,I));var F=J.length();J.y=F*Math.sin(I)*Math.sin(H);J.z=F*Math.cos(I);J.x=F*Math.sin(I)*Math.cos(H);J.multiplyScalar(C);G.copy(this.center).add(J);this.object.lookAt(this.center);F=J.length();this.axes.position=this.center.clone();this.axes.scale.x=this.axes.scale.y=this.axes.scale.z=F*0.05;this.axes.updateMatrixWorld(true);z=0;i=0;C=1;if(r.distanceTo(this.object.position)>0){this.dispatchEvent(y);r.copy(this.object.position)}};this.addEventListener("mousedown",k);this.addEventListener("mouseup",e);this.addEventListener("mousemove",p);this.addEventListener("touchstart",a);this.addEventListener("touchmove",f);this.addEventListener("mousewheel",m);this.addEventListener("DOMMouseScroll",m)};ROS3D.Viewer=function(d){var g=this;d=d||{};this.divID=d.divID;this.width=d.width;this.height=d.height;this.disableGrid=d.disableGrid;this.gridColor=d.gridColor||"#cccccc";this.background=d.background||"#111111";this.antialias=d.antialias;this.renderer=new THREE.WebGLRenderer({antialias:this.antialias});this.renderer.setClearColorHex(this.background.replace("#","0x"),1);this.renderer.sortObjects=false;this.renderer.setSize(this.width,this.height);this.renderer.shadowMapEnabled=false;this.renderer.autoClear=false;this.scene=new THREE.Scene();this.camera=new THREE.PerspectiveCamera(40,this.width/this.height,0.01,1000);this.camera.position.x=3;this.camera.position.y=3;this.camera.position.z=3;this.cameraControls=new ROS3D.OrbitControls(this.scene,this.camera);this.cameraControls.userZoomSpeed=0.5;if(!this.disableGrid){var b=new THREE.PlaneGeometry(50,50,50,50);var c=new THREE.MeshBasicMaterial({color:this.gridColor,wireframe:true,wireframeLinewidth:1,transparent:true});var f=new THREE.Mesh(b,c);this.scene.add(f)}this.scene.add(new THREE.AmbientLight(5592405));this.directionalLight=new THREE.DirectionalLight(16777215);this.scene.add(this.directionalLight);this.selectableObjs=new THREE.Object3D;this.scene.add(this.selectableObjs);var e=new ROS3D.MouseHandler(this.renderer,this.camera,this.selectableObjs,this.cameraControls);this.highlighter=new ROS3D.Highlighter(e);var a=function(){g.cameraControls.update();g.directionalLight.position=g.camera.localToWorld(new THREE.Vector3(-1,1,0));g.directionalLight.position.normalize();g.renderer.clear(true,true,true);g.renderer.render(g.scene,g.camera);g.highlighter.renderHighlight(g.renderer,g.scene,g.camera);requestAnimationFrame(a)};document.getElementById(this.divID).appendChild(this.renderer.domElement);a()};ROS3D.Highlighter=function(a){this.hoverObjs=[];this.onMouseOver=function(b){this.hoverObjs.push(b.currentTarget)};this.onMouseOut=function(b){this.hoverObjs.splice(this.hoverObjs.indexOf(b.currentTarget),1)};this.getWebglObjects=function(f,e,d){var b=f.__webglObjects;for(var h=0;h<e.length;h++){if(e[h]){for(var g=b.length-1;g>=0;g--){if(b[g].object===e[h]){d.push(b[g]);break}}this.getWebglObjects(f,e[h].children,d)}}};this.renderHighlight=function(d,e,b){var c=[];this.getWebglObjects(e,this.hoverObjs,c);e.overrideMaterial=new THREE.MeshBasicMaterial({fog:false,opacity:0.5,depthTest:true,depthWrite:false,polygonOffset:true,polygonOffsetUnits:-1,side:THREE.DoubleSide});var f=e.__webglObjects;e.__webglObjects=c;d.render(e,b);e.__webglObjects=f;e.overrideMaterial=null};a.addEventListener("mouseover",this.onMouseOver.bind(this));a.addEventListener("mouseout",this.onMouseOut.bind(this))};ROS3D.MouseHandler=function(c,a,b,e){THREE.EventDispatcher.call(this);this.camera=a;this.rootObj=b;this.renderer=c;this.fallbackTarget=e;this.lastTarget=e;this.dragging=false;this.projector=new THREE.Projector();var d=["contextmenu","click","dblclick","mouseout","mousedown","mouseup","mousemove","mousewheel","DOMMouseScroll","touchstart","touchend","touchcancel","touchleave","touchmove"];this.listeners={};this.processDomEvent=function(n){n.preventDefault();var o=n.target;var q=o.getBoundingClientRect();var k=n.clientX-q.left-o.clientLeft+o.scrollLeft;var p=n.clientY-q.top-o.clientTop+o.scrollTop;var h=k/o.clientWidth*2-1;var f=-p/o.clientHeight*2+1;var j=new THREE.Vector3(h,f,0.5);this.projector.unprojectVector(j,this.camera);var m=new THREE.Raycaster(this.camera.position.clone(),j.sub(this.camera.position).normalize());var r=m.ray;var g={mousePos:new THREE.Vector2(h,f),mouseRay:r,domEvent:n,camera:this.camera,intersection:this.lastIntersection};if(n.type=="mouseout"){if(this.dragging){this.notify(this.lastTarget,"mouseup",g);this.dragging=false}this.notify(this.lastTarget,"mouseout",g);this.lastTarget=null;return}if(this.dragging){this.notify(this.lastTarget,n.type,g);if((n.type==="mouseup"&&n.button===2)||n.type==="click"){this.dragging=false}return}var o=this.lastTarget;var i=[];i=m.intersectObject(this.rootObj,true);if(i.length>0){o=i[0].object;g.intersection=this.lastIntersection=i[0]}else{o=this.fallbackTarget}if(o!==this.lastTarget){var l=this.notify(o,"mouseover",g);if(l){this.notify(this.lastTarget,"mouseout",g)}else{o=this.fallbackTarget;if(o!==this.lastTarget){this.notify(o,"mouseover",g);this.notify(this.lastTarget,"mouseout",g)}}}this.notify(o,n.type,g);if(n.type==="mousedown"){this.dragging=true}this.lastTarget=o};this.notify=function(h,g,f){f.type=g;f.cancelBubble=false;f.stopPropagation=function(){f.cancelBubble=true};f.currentTarget=h;while(f.currentTarget){if(f.currentTarget.dispatchEvent&&f.currentTarget.dispatchEvent instanceof Function){f.currentTarget.dispatchEvent(f);if(f.cancelBubble){this.dispatchEvent(f);return true}}f.currentTarget=f.currentTarget.parent}return false};this.destroy=function(){this.listeners.forEach(function(f){this.renderer.domElement.removeEventListener(eventName,f,false)},this)};d.forEach(function(f){this.listeners[f]=this.processDomEvent.bind(this);this.renderer.domElement.addEventListener(f,this.listeners[f],false)},this)};